# Fix Location Detection Issues in Calendar View

## Context
The calendar view is falling back to Derry, NH coordinates even when location permission is enabled. The issue is that the calendar view doesn't automatically request user location like the list view does, so it never gets actual user coordinates and always uses the hardcoded fallback.

## Technical Requirements

### Current Issues Identified
1. **Calendar View Location Request Issue** ✅ FIXED:
   - `useCalendarEvents.ts` uses `useUserLocation` but never calls the `request()` function
   - CalendarView lacks auto-location-request logic that ListView has
   - LocationPermissionOverlay only shows when status is 'denied' or 'prompt', but never shows initially when status is 'checking'
   - Result: Calendar always falls back to Derry, NH because userCoords is always null

2. **ListView API Call Issue** ✅ PARTIALLY FIXED:
   - Calls `api.browse({ range: 90 })` without location parameters
   - Should use user location when available for better relevance

3. **ListView Empty Results Issue** ❌ NEW ISSUE DISCOVERED:
   - Location-based API calls with 50-mile radius return no events when user is far from event locations
   - Need fallback strategy to ensure users always see some events
   - Should use larger radius or cascading search approach

### Files to Modify

#### Core Fix - Calendar Location Request
- `ui/src/hooks/useCalendarEvents.ts` - Add automatic location request logic
- `ui/src/routes/CalendarView.tsx` - Add auto-location-request logic (similar to ListView)

#### Secondary Fix - ListView API Enhancement
- `ui/src/routes/ListView.tsx` - Update API call to use location when available

#### Tertiary Fix - ListView Fallback Strategy ✅ FIXED
- `ui/src/routes/ListView.tsx` - Increased radius from 50 to 200 miles
- Provides better event coverage while maintaining location-based relevance

### Technical Implementation

#### 1. Fix Calendar Location Request Issue
**Primary Solution**: Add automatic location request to `useCalendarEvents.ts`

```typescript
// Add to useCalendarEvents.ts
const { coords: userCoords, status, request } = useUserLocation();

// Add useEffect to auto-request location
useEffect(() => {
  if (!userCoords && status === 'prompt') {
    request();
  }
}, [userCoords, status, request]);
```

**Alternative Solution**: Update CalendarView to handle location requests

```typescript
// Add to CalendarView.tsx
const { coords, status, request } = useUserLocation();

// Add auto-request logic
useEffect(() => {
  if (!coords && status === 'prompt') {
    request();
  }
}, [coords, status, request]);
```

#### 2. Enhance ListView API Calls
**File**: `ui/src/routes/ListView.tsx`
- Update the `api.browse({ range: 90 })` call to include location when available
- Use user coordinates for location-based event fetching
- Maintain existing fallback behavior when location unavailable

#### 3. Implement ListView Fallback Strategy ✅ IMPLEMENTED
**File**: `ui/src/routes/ListView.tsx`
- **Problem**: 50-mile radius too restrictive, users see no events
- **Solution**: Increased radius from 50 to 200 miles for better coverage
- **Implementation**: Changed `radius: 80467` to `radius: 321869`

```typescript
// Fixed implementation
if (coords) {
  apiParams = {
    lat: coords.lat,
    lng: coords.lng,
    radius: 321869 // 200 miles in meters (increased from 50 miles)
  };
}
```

### Implementation Approach

#### Phase 1: Fix Calendar Location Detection (Priority)
1. Add automatic location request to `useCalendarEvents.ts`
2. Test that calendar now uses actual user location instead of Derry fallback

#### Phase 2: Enhance ListView Location Usage
1. Update ListView API call to use location parameters when available
2. Ensure consistent behavior between List and Calendar views

### Key Technical Details

#### Root Cause Analysis
The issue occurs because:
1. `useUserLocation` starts with status 'checking' and coords = null
2. `useCalendarEvents` uses `userCoords` immediately, getting null
3. Null coalescing (`??`) falls back to Derry coordinates
4. Location is never requested because CalendarView doesn't have auto-request logic

#### Location Request Flow Fix
```typescript
// Current: Passive usage
const { coords: userCoords } = useUserLocation();

// Fixed: Active location management
const { coords: userCoords, status, request } = useUserLocation();

useEffect(() => {
  if (!userCoords && status === 'prompt') {
    request();
  }
}, [userCoords, status, request]);
```

### Dependencies
- Requires `useUserLocation` hook (already implemented)
- Uses existing auto-request pattern from ListView
- No new dependencies needed

### Testing Considerations
- Test calendar view with location permission granted
- Verify coordinates are retrieved and used instead of Derry fallback
- Test calendar view with location denied (should still work with Derry fallback)
- Confirm ListView and CalendarView behave consistently</contents>
</xai:function_call: write>
<parameter name="file_path">docs/features/0029_PLAN.md
