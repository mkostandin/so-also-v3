# Feature 0016: Fix Mapbox Container Warning

## Description
Fix the Mapbox GL JS warning "The map container element should be empty, otherwise the map's interactivity will be negatively impacted" that appears in the browser console.

## Technical Analysis
The warning occurs in `util.ts:531` of Mapbox GL JS when the map container element contains child elements or has unexpected content when the map initializes. This can happen due to:

1. **Timing Issues**: Map initialization occurs before the React component has fully cleaned up the container
2. **Loading State Interference**: The loading overlay might interfere with map initialization
3. **React Strict Mode**: Double rendering in development can cause container conflicts
4. **Container Content**: Unexpected child elements or attributes in the map container div

## Current Implementation Issues
- The map container div is created with a ref but may have CSS classes or other attributes that Mapbox doesn't expect
- The loading state renders content that could potentially interfere with map initialization timing
- No explicit container cleanup before map initialization

## Solution Approach

### Phase 1: Container Cleanup (Data Layer)
**Files to modify:**
- `ui/src/hooks/useMapboxMap.ts` - Add explicit container cleanup before map initialization
- `ui/src/lib/mapbox.ts` - Add container validation utility

**Changes:**
1. Clear all child elements from map container before initializing Mapbox
2. Remove any unexpected attributes or classes that might interfere
3. Add container validation to ensure it's ready for Mapbox

### Phase 2: Map Initialization Safeguards (API Layer)
**Files to modify:**
- `ui/src/components/MapboxMap.tsx` - Ensure loading state doesn't interfere with map container
- `ui/src/hooks/useMapboxMap.ts` - Add initialization guards and better error handling

**Changes:**
1. Ensure map container is completely empty before map initialization
2. Add delay or proper sequencing to prevent race conditions
3. Improve error handling for container-related issues

### Phase 3: Component Structure Improvements (UI Layer)
**Files to modify:**
- `ui/src/components/MapboxMap.tsx` - Separate loading UI from map container

**Changes:**
1. Move loading overlay outside the map container div
2. Ensure map container is isolated and clean
3. Add proper cleanup on component unmount

## Implementation Details

### Container Cleanup Algorithm
1. Before map initialization, clear all child elements from container
2. Remove any Mapbox-related classes or attributes
3. Ensure container has only the expected dimensions and positioning
4. Validate container is ready for Mapbox initialization

### Timing Safeguards
1. Add a small delay before map initialization if container isn't ready
2. Use React's flushSync or proper state management to ensure DOM is stable
3. Add container readiness check before proceeding with map creation

### Error Recovery
1. Catch container-related errors during map initialization
2. Provide fallback behavior if container cleanup fails
3. Log detailed error information for debugging

## Files to Create/Modify
- `ui/src/hooks/useMapboxMap.ts` (modify)
- `ui/src/lib/mapbox.ts` (modify)
- `ui/src/components/MapboxMap.tsx` (modify)

## Testing Strategy
1. Verify warning no longer appears in console
2. Test map loading on different browsers and devices
3. Ensure loading states still work properly
4. Test error recovery scenarios
5. Verify map functionality remains intact

## Success Criteria
- Mapbox warning "util.ts:531" no longer appears in console
- Map loads successfully without interactivity issues
- Loading states display correctly without interfering with map
- Error handling works properly for edge cases
- No regression in existing map functionality
