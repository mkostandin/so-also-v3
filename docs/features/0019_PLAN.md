# Feature: Distance-Based Event List with Pagination

## Brief Description
Replace the nearby slider and radius-based filtering with a system that shows the 50 nearest events sorted by distance from the user. If location is not available, show a message to enable location. Add pagination with a "Load More" button to display additional events in batches of 50.

## Current State Analysis
- `NearbyEventsToggle` component provides radius-based filtering with options (6mi, 15mi, 30mi, 60mi, All)
- `ListView` component implements complex filtering logic with distance calculations
- `useLocationPreferences` hook manages nearby toggle and radius settings
- `LocationPermissionBanner` shows when location permission is needed

## Technical Implementation Plan

### Phase 1: Remove Nearby Toggle and Simplify Preferences

**Files to modify:**
- `ui/src/components/NearbyEventsToggle.tsx` - Remove this component entirely
- `ui/src/hooks/useLocationPreferences.ts` - Remove nearbyEnabled and radiusMeters from preferences
- `ui/src/routes/ListView.tsx` - Remove imports and references to NearbyEventsToggle

**Implementation:**
1. Delete `NearbyEventsToggle.tsx` component
2. Simplify `useLocationPreferences` to remove location preferences entirely
3. Remove NearbyEventsToggle from ListView imports and JSX

### Phase 2: Implement Distance-Based Sorting with Pagination

**Files to modify:**
- `ui/src/routes/ListView.tsx` - Complete rewrite of filtering and sorting logic

**Implementation:**
1. **State Management:**
   - Add `page` state for pagination (starts at 1)
   - Add `isLoadingMore` state for load more button
   - Add `allEvents` state to store complete event list
   - Add `displayedEvents` state for current visible events

2. **Distance Sorting Algorithm:**
   ```typescript
   // Sort all events by distance from user location
   const sortedByDistance = allEvents
     .filter(event => event.latitude && event.longitude) // Only events with coordinates
     .map(event => ({
       ...event,
       distanceMeters: coords ? haversineMeters(
         coords.lat, coords.lng,
         event.latitude, event.longitude
       ) : Infinity
     }))
     .sort((a, b) => a.distanceMeters - b.distanceMeters);
   ```

3. **Pagination Logic:**
   ```typescript
   // Show first (page * 50) events
   const eventsPerPage = 50;
   const endIndex = page * eventsPerPage;
   const displayedEvents = sortedByDistance.slice(0, endIndex);
   const hasMoreEvents = sortedByDistance.length > endIndex;
   ```

4. **Load More Handler:**
   ```typescript
   const handleLoadMore = () => {
     setIsLoadingMore(true);
     setTimeout(() => {
       setPage(prev => prev + 1);
       setIsLoadingMore(false);
     }, 500); // Simulate loading delay
   };
   ```

### Phase 3: Location Permission Handling

**Files to modify:**
- `ui/src/routes/ListView.tsx` - Update location permission logic
- `ui/src/components/LocationPermissionBanner.tsx` - Modify banner message and behavior

**Implementation:**
1. **Location Status Check:**
   ```typescript
   if (!coords) {
     // Show location permission banner
     return <LocationPermissionBanner />;
   }
   ```

2. **Banner Enhancement:**
   - Change message to "Enable location to see events sorted by distance"
   - Make the banner more prominent since location is now required for proper sorting

### Phase 4: UI Updates

**Files to modify:**
- `ui/src/routes/ListView.tsx` - Update JSX structure

**Implementation:**
1. **Conditional Rendering:**
   ```typescript
   if (!coords) {
     return (
       <div className="mx-auto max-w-3xl p-2">
         <LocationPermissionBanner />
         <div className="text-center py-8 text-gray-500">
           Please enable location to see events sorted by distance
         </div>
       </div>
     );
   }
   ```

2. **Load More Button:**
   ```typescript
   {hasMoreEvents && (
     <div className="flex justify-center mt-6">
       <button
         onClick={handleLoadMore}
         disabled={isLoadingMore}
         className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
       >
         {isLoadingMore ? 'Loading...' : `Load More Events (${sortedByDistance.length - displayedEvents.length} remaining)`}
       </button>
     </div>
   )}
   ```

3. **Event Count Display:**
   ```typescript
   <h3 className="text-lg font-semibold">
     Events ({displayedEvents.length}{hasMoreEvents ? ` of ${sortedByDistance.length}` : ''})
   </h3>
   ```

### Phase 5: Cleanup and Optimization

**Files to modify:**
- `ui/src/routes/ListView.tsx` - Remove unused imports and clean up code
- `ui/src/hooks/useUserLocation.ts` - Ensure location request logic still works

**Implementation:**
1. Remove unused imports (`useLocationPreferences`, `NearbyEventsToggle`)
2. Clean up the `useEffect` for location permission (remove nearbyEnabled check)
3. Optimize distance calculations to avoid recalculating on every render
4. Ensure proper cleanup of pagination state

## Key Technical Details

### Distance Calculation Algorithm
- Uses Haversine formula to calculate distance between user coordinates and event coordinates
- Only calculates distance for events that have both latitude and longitude
- Events without coordinates are placed at the end of the list (Infinity distance)

### Pagination Algorithm
- Maintains complete sorted list in memory
- Shows progressive batches of 50 events
- Tracks loading state for smooth UX
- Shows remaining event count in load more button

### Location Permission Flow
1. Check if coordinates are available on component mount
2. If not available, show permission banner
3. User clicks "Allow location" → triggers browser permission prompt
4. Once granted, coordinates become available → triggers re-render with distance sorting

## Files Requiring Changes
- `ui/src/components/NearbyEventsToggle.tsx` (delete)
- `ui/src/hooks/useLocationPreferences.ts` (simplify/remove)
- `ui/src/routes/ListView.tsx` (major rewrite)
- `ui/src/components/LocationPermissionBanner.tsx` (minor updates)

## Testing Requirements
- Test with location permission granted: should show events sorted by distance
- Test with location permission denied: should show permission banner
- Test pagination: load more button should work correctly
- Test event count display: should show accurate counts
- Test events without coordinates: should appear at end of list
