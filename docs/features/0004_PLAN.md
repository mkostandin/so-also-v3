# Feature Plan: Event Submission Form with Cloudflare R2 Image Upload

## Overview
Implement a comprehensive event submission form supporting different event types with appropriate date/time patterns, using Cloudflare R2 SDK for image storage and display of uploaded images on event detail pages:

- **YPAA Meetings**: Weekly recurring on same day (e.g., every Tuesday)
- **Committee Meetings**: Monthly recurring (e.g., second Saturday of each month)
- **Conferences**: Multi-day events with start and end dates
- **Events/Other**: Single-day or one-off dates (like 6/10/2025)

## Current State
- `ui/src/routes/SubmitEvent.tsx` contains placeholder "Form coming soon"
- Existing event schema supports single datetime events only
- Series schema exists for recurring events with RRULE support
- No image storage infrastructure
- No R2 configuration in Cloudflare setup
- EventItem type missing image fields

## Required Changes

### Phase 1: Data Layer - Database Schema & R2 Setup

#### Database Schema Updates
**File: `server/src/schema/events.ts`**
- Add `image_urls: jsonb('image_urls').$type<string[]>().default([])` field to store array of R2 image URLs
- Update `Event` and `NewEvent` types to include image URLs
- **Schema Note**: Conferences use `starts_at_utc`/`ends_at_utc` for date range, while single events use same field for single datetime

#### R2 Configuration
**File: `server/wrangler.toml`**
- Add R2 bucket binding: `[[r2_buckets]] binding = "EVENT_IMAGES" bucket_name = "event-images"`
- Add environment variables: `R2_ACCOUNT_ID`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY`

**File: `server/platforms/cloudflare/wrangler.toml.template`**
- Add corresponding R2 configuration template

#### Environment Variables
**Files: `.env` (document for user)**
- Add `R2_ACCOUNT_ID`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY` to environment setup

### Phase 2A: API Layer - Image Upload & Enhanced Event Creation

#### Image Upload API
**File: `server/src/api.ts`**
- Add `POST /upload-image` endpoint using Cloudflare R2 SDK
- Implement file validation (size limits, image types: JPEG, PNG, WebP)
- Generate unique filenames with timestamp/user prefix
- Return public URL upon successful upload

#### Enhanced Event Creation Schema
**File: `server/src/api.ts`**
- Extend `createEventSchema` to support event type-specific date patterns:
  - **Single Events/Other**: `singleDate: z.string().datetime()` (one-off dates like 6/10/2025)
  - **YPAA Meetings**: `weeklyDay: z.enum(['monday','tuesday','wednesday','thursday','friday','saturday','sunday'])`
  - **Committee Meetings**: `monthlyPattern: z.object({ weekday: z.string(), position: z.number() })` (e.g., second Saturday)
  - **Conferences**: `dateRange: z.object({ startDate: z.string().datetime(), endDate: z.string().datetime() })`
- Add `imageUrls: z.array(z.string().url()).optional()` field

#### Event Type-Specific Logic
**File: `server/src/api.ts`**
- **YPAA Meetings**: Create series with `freq: 'weekly'`, `interval: 1`, `by_weekday: [selectedDay]`
- **Committee Meetings**: Create series with `freq: 'monthly'`, `interval: 1`, `by_weekday: [weekday]`, `by_set_pos: [position]`
- **Conferences**: Create single event record with separate start/end dates
- **Single Events**: Standard event creation with single datetime
- Trigger appropriate materialization job based on event type

### Phase 2B: UI Layer - Enhanced Submission Form

#### Form Component Structure
**File: `ui/src/routes/SubmitEvent.tsx`**
- Replace placeholder with comprehensive form using React Hook Form + Zod validation
- Implement two-mode interface: Single Date vs Recurring Pattern
- Add image upload component with drag-drop functionality
- Integrate with existing UI components (shadcn/ui)

#### Image Upload Component
**File: `ui/src/components/ImageUpload.tsx` (new)**
- Drag-and-drop interface for multiple image selection
- Progress indicators during upload
- Preview thumbnails with remove functionality
- File validation (size, type) before upload
- Error handling and retry mechanisms

#### Event Type-Specific Form Sections

**Single Events/Other:**
- Date picker for specific date (6/10/2025 format)
- Start/end time selection
- Single-day event creation

**YPAA Meetings (Weekly):**
- Day of week selector (Monday-Sunday)
- Start time selection
- Weekly recurring pattern (same day every week)
- Optional end date or occurrence count

**Committee Meetings (Monthly):**
- Weekday selector (Monday-Sunday)
- Position selector (1st, 2nd, 3rd, 4th, last)
- Start time selection
- Monthly recurring pattern (e.g., "second Saturday")
- Optional end date or occurrence count

**Conferences (Multi-day):**
- Start date and end date pickers
- Start/end time selection for each day
- Multi-day event spanning date range

#### Dynamic Form Behavior
- Form fields change based on selected event type
- RRULE preview shows next 5 occurrences for recurring events
- Validation rules adapt to event type requirements
- Timezone selection for all event types

#### Form Validation
**File: `ui/src/lib/validation.ts` (new)**
- Zod schemas for both event modes
- Image validation rules
- Location/geocoding validation
- Required field logic based on event type

### Phase 3: Image Display Integration

#### Event Detail Page Updates
**File: `ui/src/routes/EventDetail.tsx`**
- Add image gallery component to display uploaded images
- Implement lightbox/modal for full-size image viewing
- Handle image loading states and errors
- Responsive grid layout for multiple images

#### EventItem Type Updates
**File: `ui/src/lib/api-client.ts`**
- Add `imageUrls?: string[]` to EventItem type
- Update API response mapping to include image URLs

#### Image Gallery Component
**File: `ui/src/components/ImageGallery.tsx` (new)**
- Grid layout for image thumbnails
- Click to expand functionality
- Loading states and error boundaries
- Accessibility features (alt text, keyboard navigation)

### Phase 4: Recurring Event Management

#### Series Integration
**File: `ui/src/components/SeriesForm.tsx` (new)**
- Reusable component for recurring pattern configuration
- RRULE builder with preset options (weekly, monthly, custom)
- Preview of generated occurrences
- Edit capabilities for existing series

#### Occurrence Display
**File: `ui/src/routes/EventDetail.tsx`**
- For recurring events, show series information
- Display next few upcoming occurrences
- Link to view all occurrences in calendar

### Behavioral Details

#### Image Upload Process
1. User selects images via drag-drop or file picker
2. Client-side validation (file type, size limits)
3. Upload to R2 via `POST /upload-image` endpoint
4. Receive array of public URLs
5. Display upload progress and success/error states
6. Allow image removal before form submission

#### Event Type Creation Flows

**Single Events/Other Creation:**
1. User selects "Event" or "Other" type
2. Picks specific date (e.g., 6/10/2025)
3. Sets start/end times
4. Standard event creation flow
5. Images uploaded and associated with event
6. Event appears in listings immediately

**YPAA Meetings (Weekly) Creation:**
1. User selects "YPAA Meeting" type
2. Chooses day of week (e.g., Tuesday)
3. Sets start time
4. System generates RRULE: `freq: 'weekly'`, `interval: 1`, `by_weekday: ['TU']`
5. Shows preview of next 5 weekly occurrences
6. Creates series record with pattern
7. Triggers materialization job

**Committee Meetings (Monthly) Creation:**
1. User selects "Committee Meeting" type
2. Chooses weekday and position (e.g., second Saturday)
3. Sets start time
4. System generates RRULE: `freq: 'monthly'`, `interval: 1`, `by_weekday: ['SA']`, `by_set_pos: [2]`
5. Shows preview of next 5 monthly occurrences
6. Creates series record with pattern
7. Triggers materialization job

**Conference Creation:**
1. User selects "Conference" type
2. Sets start date and end date range
3. Sets start/end times for each day
4. Creates single event record with date range
5. No series creation needed
6. Images uploaded and associated with event

### Files to Update/Create

#### Backend (Server)
- `server/src/schema/events.ts` - Add image_urls field
- `server/wrangler.toml` - Add R2 bucket configuration
- `server/src/api.ts` - Add image upload endpoint, enhance event creation
- `server/src/lib/env.ts` - Add R2 environment variables

#### Frontend (UI)
- `ui/src/routes/SubmitEvent.tsx` - Complete form implementation
- `ui/src/components/ImageUpload.tsx` - New image upload component
- `ui/src/components/ImageGallery.tsx` - New image display component
- `ui/src/components/SeriesForm.tsx` - New recurring config component
- `ui/src/routes/EventDetail.tsx` - Add image display
- `ui/src/lib/api-client.ts` - Update EventItem type
- `ui/src/lib/validation.ts` - New validation schemas

### Test Plan

1. **Image Upload Testing:**
   - Upload single/multiple images successfully
   - Reject oversized files (>5MB)
   - Reject non-image files
   - Handle network errors gracefully
   - Display upload progress correctly

2. **Single Events/Other:**
   - Create event for specific date (6/10/2025)
   - Verify event appears in listings
   - Confirm images display on detail page
   - Test all required field validations

3. **YPAA Meetings (Weekly):**
   - Create weekly meeting (e.g., every Tuesday)
   - Verify RRULE generation: `freq: 'weekly'`, `by_weekday: ['TU']`
   - Confirm weekly occurrences are materialized
   - Test day-of-week selection and time setting

4. **Committee Meetings (Monthly):**
   - Create monthly meeting (e.g., second Saturday)
   - Verify RRULE generation: `freq: 'monthly'`, `by_set_pos: [2]`, `by_weekday: ['SA']`
   - Confirm monthly occurrences are materialized
   - Test position and weekday selection

5. **Conferences (Multi-day):**
   - Create conference with date range
   - Verify start/end date handling
   - Test multi-day time selection
   - Confirm single event record creation (no series)

6. **Cross-Platform Testing:**
   - Desktop browser upload
   - Mobile browser upload
   - Various image formats (JPEG, PNG, WebP)
   - Different network conditions

### Dependencies

#### New Packages
- `@cloudflare/r2` - R2 SDK for image storage
- `react-hook-form` - Form management (if not already present)
- `@hookform/resolvers` - Zod integration for forms
- `rrule` - RRULE generation and parsing (supports weekly, monthly with set positions)
- `react-dropzone` - Drag-drop file upload interface

#### RRULE Pattern Examples
- **YPAA Weekly**: `FREQ=WEEKLY;INTERVAL=1;BYDAY=TU` (every Tuesday)
- **Committee Monthly**: `FREQ=MONTHLY;INTERVAL=1;BYDAY=SA;BYSETPOS=2` (second Saturday)
- **Complex Monthly**: `FREQ=MONTHLY;INTERVAL=1;BYDAY=SU;BYSETPOS=3` (third Sunday)

#### Environment Setup
- Cloudflare R2 bucket creation
- API token generation with R2 permissions
- Environment variable configuration
