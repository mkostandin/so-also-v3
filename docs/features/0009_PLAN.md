# Calendar Feature Technical Plan

## Feature Description
Implement a calendar view that displays clickable links to events, conferences, and occurrences within 50 miles of the user's location, showing upcoming events in a calendar format with distance indicators.

## Data Sources and API Integration

### Available Data Types
1. **Events** (`/api/v1/events`) - Single events with location (lat/lng), timing, and various event types
2. **Occurrences** (`/api/v1/occurrences`) - Individual instances of recurring series with location data
3. **Browse Endpoint** (`/api/v1/browse`) - Unified endpoint that merges events and occurrences with location filtering

### Location Filtering
- User location available via `useUserLocation` hook
- Distance calculation using `haversineMeters` function
- API supports `lat`, `lng`, and `radius` parameters for location filtering
- Default radius: 50 miles (convert to meters: 50 * 1609.344 ≈ 80467 meters)

### Event Types to Display
- Events: All event types ('Event', 'Committee Meeting', 'Conference', 'YPAA Meeting', 'Other')
- Occurrences: All approved occurrences from recurring series
- Conferences: May need geocoding for location filtering (currently only have city data)

## Implementation Plan

### Phase 1: Enhanced Calendar Data Layer

#### 1.1 Update Calendar API Integration
**Files to modify:**
- `ui/src/routes/CalendarView.tsx` - Replace mock data with real API calls
- `ui/src/lib/api-client.ts` - Ensure proper typing for browse endpoint response

**Implementation:**
```typescript
// Use browse endpoint with location filtering
const events = await api.browse({
  range: 90, // Next 90 days
  lat: userCoords?.lat,
  lng: userCoords?.lng,
  radius: 80467 // 50 miles in meters
});
```

#### 1.2 Create Calendar Data Hook
**New file:** `ui/src/hooks/useCalendarEvents.ts`

**Responsibilities:**
- Fetch events using user's location (fallback to default if no location)
- Handle loading states and errors
- Cache events data with appropriate invalidation
- Transform API response to calendar-compatible format

#### 1.3 Location Permission Handling
**Files to modify:**
- `ui/src/routes/CalendarView.tsx` - Add location permission UI
- Integrate with existing `useUserLocation` hook
- Show appropriate messaging when location is denied/unavailable

### Phase 2: Calendar UI Enhancement

#### 2.1 Enhanced Calendar Grid
**Files to modify:**
- `ui/src/components/CalendarGrid.tsx` - Add event display logic
- `ui/src/components/CalendarEventIndicator.tsx` - Enhance to show event counts

**Features to implement:**
- Display event count per day
- Show event types with color coding
- Handle multiple events per day
- Add hover states for event preview

#### 2.2 Event List Panel
**New file:** `ui/src/components/CalendarEventList.tsx`

**Features:**
- Show events for selected date
- Display event details (name, time, distance, type)
- Clickable links to event detail pages (`/app/e/{id}`)
- Sort by time and distance
- Show distance in miles (user preference)

#### 2.3 Calendar Event Popup
**New file:** `ui/src/components/CalendarEventPopup.tsx`

**Features:**
- Quick preview of events on date hover/click
- Show event name, time, location, distance
- Direct link to event detail page
- Support for multiple events per day

### Phase 3: Navigation and Routing

#### 3.1 Calendar Navigation
**Files to modify:**
- `ui/src/routes/CalendarView.tsx` - Add month navigation
- Add week view option (future enhancement)
- Add today button for quick navigation

#### 3.2 Event Detail Integration
**Files to verify:**
- `ui/src/routes/EventDetail.tsx` - Ensure proper event display
- Navigation from calendar to event details works correctly

### Phase 4: UI/UX Enhancements

#### 4.1 Location Status Indicator
**New file:** `ui/src/components/LocationStatus.tsx`

**Features:**
- Show current location status (granted/denied/prompt)
- Allow users to retry location permission
- Display approximate location when available
- Clear messaging about location-based filtering

#### 4.2 Distance Display
**Files to modify:**
- `ui/src/lib/location-utils.ts` - Ensure proper miles conversion
- Add distance formatting utilities
- Show distances consistently across calendar components

#### 4.3 Loading and Error States
**Implementation:**
- Loading skeleton for calendar grid
- Error states for API failures
- Retry mechanisms for failed requests
- Graceful degradation when location unavailable

## Technical Considerations

### Performance Optimization
1. **Data Fetching Strategy:**
   - Fetch events for current month + buffer (previous/next month)
   - Cache events data with appropriate TTL
   - Prefetch adjacent months on navigation

2. **Location Handling:**
   - Default to major city center if no user location
   - Allow manual location override
   - Handle location permission changes gracefully

### Data Flow Architecture
```
CalendarView
├── useUserLocation (location permission & coordinates)
├── useCalendarEvents (API data fetching)
├── LocationStatus (location permission UI)
├── CalendarGrid (month display)
│   ├── CalendarEventIndicator (event count display)
│   └── CalendarEventPopup (event preview on hover)
└── CalendarEventList (selected date events)
    └── Event links → /app/e/{id}
```

### Error Handling Strategy
1. **Location Permission Denied:** Show calendar with default location, clear messaging
2. **API Errors:** Show cached data if available, retry mechanism
3. **No Events:** Show appropriate empty states with helpful messaging
4. **Network Issues:** Offline-capable with cached data

### Mobile Responsiveness
- Ensure calendar grid works on mobile devices
- Touch-friendly event selection
- Responsive event list layout
- Optimized popup positioning for mobile

## Files to Create
1. `ui/src/hooks/useCalendarEvents.ts`
2. `ui/src/components/CalendarEventList.tsx`
3. `ui/src/components/CalendarEventPopup.tsx`
4. `ui/src/components/LocationStatus.tsx`

## Files to Modify
1. `ui/src/routes/CalendarView.tsx`
2. `ui/src/components/CalendarGrid.tsx`
3. `ui/src/components/CalendarEventIndicator.tsx`
4. `ui/src/lib/api-client.ts` (if needed for typing)

## Success Criteria
- [ ] Calendar displays events within 50 miles of user location
- [ ] Events are clickable and navigate to detail pages
- [ ] Distances shown in miles with proper formatting
- [ ] Location permission handled gracefully
- [ ] Calendar works without user location (fallback)
- [ ] Mobile-responsive design
- [ ] Loading states and error handling implemented
- [ ] Performance optimized for smooth navigation
