# Feature 0026: Fix location permission indicator flashing in calendar view

## Brief description
The calendar view currently shows a location permission indicator that flashes briefly before disappearing when location services are already granted. This creates a poor user experience where the page loads with an overlay/banner, then immediately removes it. We need to eliminate this flashing by preventing the indicator from showing during the initial permission check.

## Root cause analysis
- **Initial state issue**: `useUserLocation` hook initializes with `status = 'prompt'`
- **Premature rendering**: Location indicators render immediately when status is 'prompt'
- **Async delay**: `navigator.permissions.query()` takes time to resolve
- **Flash effect**: Brief moment between initial render and permission check completion

## Current flow causing flash
1. Page loads → `useUserLocation` state = 'prompt'
2. `LocationPermissionOverlay`/`LocationPermissionBanner` render (status === 'prompt')
3. Async permission check executes (`navigator.permissions.query()`)
4. Permission check resolves → status updates to 'granted'
5. Indicators disappear → flash effect visible to user

## Files to change
- `ui/src/hooks/useUserLocation.ts` - Add 'checking' state and proper loading handling
- `ui/src/lib/geolocation.ts` - Add 'checking' to GeoPermissionState type
- `ui/src/components/LocationPermissionOverlay.tsx` - Update to handle 'checking' state
- `ui/src/components/LocationPermissionBanner.tsx` - Update to handle 'checking' state
- `ui/src/routes/ListView.tsx` - Minor update for consistency

## Technical plan

### Phase 1 — Update geolocation types and hook
**`ui/src/lib/geolocation.ts` changes:**
- Add 'checking' to `GeoPermissionState` type
- Ensure type includes all permission states

**`ui/src/hooks/useUserLocation.ts` changes:**
- Change initial state from `'prompt'` to `'checking'`
- Add loading state management
- Ensure status only updates after permission check completes
- Add proper cleanup for mounted state

### Phase 2 — Update permission indicator components
**`ui/src/components/LocationPermissionOverlay.tsx` changes:**
- Update condition to exclude 'checking' state: `status !== 'denied' && status !== 'prompt' && status !== 'checking'`
- Add optional loading indicator during 'checking' state (minimal, non-intrusive)
- Maintain existing styling and behavior for actual permission prompts

**`ui/src/components/LocationPermissionBanner.tsx` changes:**
- Update condition to only show when `status === 'prompt'` (exclude 'checking')
- Remove banner during initial permission check
- Keep existing functionality intact

### Phase 3 — Update consuming components
**`ui/src/routes/ListView.tsx` changes:**
- Update banner condition for consistency: `{!coords && status === 'prompt' && <LocationPermissionBanner />}`
- Ensure no changes to existing functionality

## Implementation details

### New permission state flow
1. **Initial load**: status = 'checking' → no indicators shown
2. **Permission check**: async `navigator.permissions.query()` executes
3. **State update**: status = 'granted'/'denied'/'prompt'/'unsupported'
4. **UI update**: appropriate indicators show based on final state
5. **No flash**: indicators never appear during the checking phase

### Backward compatibility
- All existing functionality preserved
- Error handling unchanged
- Request flow remains identical
- Only affects initial loading behavior

## Validation criteria
- **No flash effect**: Page loads without showing permission indicators when location is granted
- **Proper indicators**: Permission prompts still appear when needed (denied/prompt states)
- **Loading behavior**: Smooth transition from checking to final state
- **Functionality intact**: All existing location features work as before
- **Performance**: No impact on permission check timing or user experience

## Rollback plan
- Original behavior can be restored by reverting initial state to 'prompt'
- Feature flag could be added if needed for gradual rollout
- No database or API changes required

## Testing scenarios
1. **Location granted**: Page loads without flash, no indicators shown
2. **Location denied**: Permission overlay/banner appears appropriately
3. **First visit**: Permission prompt appears without flash
4. **Slow network**: Loading state handled gracefully during permission check
5. **Unsupported browser**: Fallback behavior works correctly</contents>
</xai:function_call">Successfully created technical plan for fixing the location permission indicator flashing issue.
