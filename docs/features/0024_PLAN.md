# Feature 0024: Diagnose and fix pre-existing Mapbox load failure

## Brief description
Users see “Loading map…” followed by repeated retries and eventual failure. This behavior existed before 0023 changes. We need to isolate the root cause (style/token/container/layers/cors/sw) and harden initialization to ensure the map reliably reaches the ready state.

## Hypothesis areas
- Style fetch blocked or invalid (Mapbox style URL or auth)
- Layers/sources added before style is ready causing internal errors
- Service Worker caching interference under `/app` scope
- Progress not observed, watchdog misclassifying as hung
- Event/layer code path throwing and preventing load completion

## Files to inspect/adjust
- `ui/src/hooks/useMapboxMap.ts` — map init, load/error wiring
- `ui/src/components/MapboxMap.tsx` — readiness/error surfacing
- `ui/src/components/MapLayers.tsx` — source/layer lifecycle
- `ui/src/lib/mapbox.ts` — style URL, token init
- `ui/public/app/sw.js` — SW cache behavior for style/tiles when scoped under `/app`

## Plan of action

### Phase 1 — Instrumentation and classification
- Add structured logs for:
  - time-to-load (map `load` event), first `styledata`, first `render`, first `idle`
  - error category: token/config, container/empty, style fetch, layer/source add
- Surface error.details in UI to distinguish classes fast.

### Phase 2 — Minimal style and guarded layers
- Add an alternate minimal style option in `getDefaultMapConfig()`:
  - Start with `mapbox://styles/mapbox/light-v11` or a barebones style
  - Make style overrideable via prop to `MapboxMap` for A/B test
- In `MapLayers.tsx`, guard layer/source creation:
  - Wait for `map.isStyleLoaded()` and attach a one-time `load` guard
  - Check for existing source/layers before adding; wrap addSource/addLayer in try/catch

### Phase 3 — Strict readiness and progress pings
- Ensure `onProgress` fires on `styledata`, `sourcedata`, `dataloading`, `render`, `idle`
- Treat `load` as definitive readiness; do not mark ready on `render` alone
- Reset watchdog on any progress ping; only fallback when no progress for full timeout

### Phase 4 — SW and network isolation (no SW changes by default)
- We will NOT disable or change the service worker at this time. Your SW is scoped to `/app` and Mapbox requests are cross-origin, so it should not intercept them.
- Only if diagnostics later indicate SW interference will we add a targeted bypass for Mapbox domains.
- Verify CSS import of `mapbox-gl/dist/mapbox-gl.css` is present (already in `ui/src/main.tsx`).

### Phase 5 — Error handling improvements
- Token/config errors: show clear non-retrying guidance
- Style fetch 4xx/5xx: backoff and retry, but cap attempts; display specific code
- Layer/source conflicts: remove/recreate source/layers with defensive checks

## Concrete edits
- `useMapboxMap.ts`:
  - Ensure `map.on('load')` -> call `onMapLoad` and emit `onProgress`
  - Keep progress events and cleanup intact
- `MapLayers.tsx`:
  - Before `addSource`/`addLayer`, check `isStyleLoaded`; if not, attach `map.once('load', ...)`
  - Wrap calls in try/catch and log errors back via console with layer/source ids
  - On cleanup, check for existence before removal (already present)
- `lib/mapbox.ts`:
  - Add optional `getMinimalMapConfig()` returning a simpler style for diagnosis
- `MapboxMap.tsx`:
  - Accept `useMinimalStyle?: boolean` prop to switch style via hook/init
- `public/app/sw.js`:
  - No changes planned initially. Consider a targeted bypass for Mapbox domains only if diagnostics show SW interference.

## Rollback and toggles
- Keep a toggle to disable minimal style and SW bypass once stability confirmed

## Validation
- Desktop and mobile with throttled network: map reaches `load`, watchdog remains calm due to progress pings
- SW left unchanged: confirm that Mapbox assets are not being intercepted; if they are, consider targeted bypass
- No silent errors from layer/source add; retries only on genuine failures
