# Feature Plan: Enhanced Event Details Page

## Overview
Enhance the existing Event Details page with a comprehensive, user-friendly layout that includes committee-specific notifications, PWA installation prompts, and improved visual hierarchy.

## Current State Analysis
- Event schema already contains all required fields (name, event_type, committee, description, date/time, location, images, website_url, contact_email)
- Basic EventDetail component exists but lacks the requested layout and functionality
- PWA manifest and infrastructure already in place
- Existing utility functions available (formatDate, Tooltip, Switch components)

## Implementation Plan

### Phase 1: Enhanced Event Details UI
**Files to modify:**
- `ui/src/routes/EventDetail.tsx` - Main event details page component
- `ui/src/lib/session-utils.ts` - May need to add PWA installation utilities
- `ui/src/components/ui/tooltip.tsx` - Already available for info popup
- `ui/src/components/ui/switch.tsx` - Already available for notifications toggle

**Key Changes:**

1. **Layout Reorganization:**
   - Event title at top
   - Type tag and committee tag below title
   - Image gallery (if images exist) below tags
   - Share and Directions buttons below image
   - Committee notifications toggle with info tooltip below buttons
   - Description section below notifications
   - Date in "Saturday November 5th" format below description
   - Location section below date
   - Committee website and email below location (if provided)

2. **Committee Notifications Toggle:**
   - Create new component `CommitteeNotificationsToggle.tsx`
   - Use existing Switch component with custom styling
   - Integrate with localStorage for preference persistence
   - Add info icon with tooltip explaining:
     - "On the day of the event you will get notification of the event and conference"
     - "Must install app" with clickable "install app" link

3. **PWA Installation Functionality:**
   - Add PWA installation detection logic
   - Create installation prompt when "install app" is clicked
   - Handle cases where app is already installed
   - Use `beforeinstallprompt` event for installation flow

4. **Date Formatting:**
   - Use existing `formatDate` function from `session-utils.ts`
   - Ensure consistent "Saturday November 5th" format

5. **Schema Verification:**
   - Confirm all required fields are captured in event submission:
     - Event type ✓ (already exists)
     - Committee ✓ (already exists)
     - Description ✓ (already exists)
     - Date/time ✓ (already exists)
     - Location ✓ (already exists)
     - Images ✓ (already exists)
     - Committee website ✓ (already exists)
     - Contact email ✓ (already exists)

### Technical Implementation Details

**New Component: CommitteeNotificationsToggle**
```typescript
interface CommitteeNotificationsToggleProps {
  committeeSlug: string;
  committeeName: string;
}
```

**PWA Installation Logic:**
- Detect if app is already installed using `window.matchMedia('(display-mode: standalone)').matches`
- Handle `beforeinstallprompt` event for deferred installation
- Show appropriate message when app is already installed

**Layout Structure:**
```jsx
<div className="event-details relative">
  {/* 3-dot menu button - Top right */}
  <div className="absolute top-4 right-4 group">
    <button className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
      <svg className="w-4 h-4 text-gray-600 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
      </svg>
    </button>
    {/* Dropdown menu with FlagButton */}
    <div className="absolute right-0 mt-1 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg border border-gray-200 dark:border-gray-700 z-10 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
      <div className="py-2">
        <div className="px-3">
          <FlagButton className="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 text-sm font-medium cursor-pointer" />
        </div>
      </div>
    </div>
  </div>

  {/* Event Title - Centered */}
  <div className="text-center">
    <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-2">{event.name}</h1>
  </div>

  {/* Event Tags - Centered */}
  <div className="flex justify-center gap-3">
    {event.eventType && (
      <span className="inline-block bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-sm px-4 py-2 rounded-full font-medium">
        {event.eventType}
      </span>
    )}
    {event.committee && (
      <span className="inline-block bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-sm px-4 py-2 rounded-full font-medium">
        {event.committee}
      </span>
    )}
  </div>

  {/* Image Gallery */}
  {event.imageUrls && event.imageUrls.length > 0 && (
    <div className="w-full">
      <ImageGallery images={event.imageUrls} />
    </div>
  )}

  {/* Action Buttons - Centered */}
  <div className="flex justify-center gap-4">
    <button className="bg-blue-600 text-white px-6 py-3 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
      Share
    </button>
    <button className="bg-gray-900 text-white px-6 py-3 rounded-lg text-sm font-medium hover:bg-black/80 transition-colors dark:bg-gray-700 dark:hover:bg-gray-600">
      Get Directions
    </button>
  </div>

  {/* Committee Notifications Toggle with Mobile Tooltip */}
  {event.committee && event.committeeSlug && (
    <CommitteeNotificationsToggle
      committeeSlug={event.committeeSlug}
      committeeName={event.committee}
    />
  )}

  {/* Description - Left-aligned */}
  {event.description && (
    <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
      <p className="text-gray-700 dark:text-gray-300 leading-relaxed text-left">{event.description}</p>
    </div>
  )}

  {/* Date - Left-aligned */}
  {event.startsAtUtc && (
    <div className="text-left">
      <p className="text-xl font-semibold text-gray-900 dark:text-white">
        {formatDate(event.startsAtUtc)}
      </p>
    </div>
  )}

  {/* Location - Left-aligned */}
  {(event.address || event.city || event.stateProv) && (
    <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
      <h3 className="font-semibold text-gray-900 dark:text-white mb-3 text-left">Location</h3>
      <div className="text-left space-y-1">
        {event.address && <p className="text-gray-700 dark:text-gray-300">{event.address}</p>}
        {(event.city || event.stateProv) && (
          <p className="text-gray-700 dark:text-gray-300">
            {[event.city, event.stateProv].filter(Boolean).join(', ')}
          </p>
        )}
        {event.distanceMeters !== undefined && isFinite(event.distanceMeters) && (
          <p className="text-sm text-gray-600 dark:text-gray-400 mt-2">
            {metersToMiles(event.distanceMeters).toFixed(1)} miles away
          </p>
        )}
      </div>
    </div>
  )}

  {/* Contact Information - With no-email handling */}
  {(event.websiteUrl || event.contactEmail) && (
    <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
      <h3 className="font-semibold text-gray-900 dark:text-white mb-3 text-center">Contact Information</h3>
      <div className="flex flex-col items-center gap-3">
        {event.websiteUrl && (
          <a href={event.websiteUrl} target="_blank" rel="noopener noreferrer" className="bg-green-600 text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
            Visit Committee Website
          </a>
        )}
        {event.contactEmail && (
          <button onClick={handleContactCommittee} className="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
            Contact Committee
          </button>
        )}
      </div>
    </div>
  )}

  {/* No Email Dialog */}
  <Dialog open={showNoEmailDialog} onOpenChange={setShowNoEmailDialog}>
    <DialogContent>
      <DialogHeader>
        <DialogTitle>No Email Available</DialogTitle>
        <DialogDescription>
          No email was submitted with this event.
        </DialogDescription>
      </DialogHeader>
      <div className="flex justify-end">
        <Button onClick={() => setShowNoEmailDialog(false)}>OK</Button>
      </div>
    </DialogContent>
  </Dialog>
</div>
```

### Dependencies
- Existing shadcn components (Switch, Tooltip, Button)
- Existing utility functions (formatDate, location-utils)
- Existing PWA infrastructure
- No new packages required

### Mobile-Specific Features
- **Tooltip behavior optimized for touch devices:**
  - Custom mobile tooltip implementation (separate from desktop Radix tooltip)
  - Tap to open/close on mobile devices
  - Closes when tapping elsewhere or scrolling (mobile)
  - Maintains standard hover behavior on desktop
  - Left-aligned positioning to prevent right-side viewport cutoff
  - Viewport-aware sizing with `max-w-[min(24rem,calc(100vw-3rem))]`
  - Minimum width of 256px to prevent overly narrow tooltips

- **3-dot menu with mobile/desktop support:**
  - Desktop: Hover to show dropdown menu
  - Mobile: Click to show dropdown menu
  - Closes on scroll or outside tap (mobile)
  - Contains FlagButton for reporting issues
  - FlagButton renders as text menu item instead of button

- **Contact Committee with no-email handling:**
  - Checks if email exists before opening mailto link
  - Shows "No email submitted with event" popup when no email available
  - Graceful fallback for events without contact information

- **Text alignment optimizations:**
  - Description, date, and location sections changed to left-aligned
  - Improved readability on mobile devices
  - Maintains centered layout for title, tags, and buttons

### Testing Requirements
- Test PWA installation flow on various browsers
- Test notifications toggle persistence
- Test responsive layout on mobile/desktop
- Test tooltip functionality on both mobile and desktop
- Test share and directions functionality
- Verify date formatting across different locales
- Test mobile tooltip tap-to-open/close behavior
- Test tooltip closes on scroll/tap outside on mobile
- Test 3-dot menu hover/click behavior on desktop/mobile
- Test FlagButton text menu item functionality
- Test no-email popup appears when contact email is missing
- Test Contact Committee opens mailto when email exists
- Test left-aligned text layout on mobile devices
- Test accessibility compliance with DialogDescription

### Implementation Details

**Files Created/Modified:**
- `ui/src/routes/EventDetail.tsx` - Enhanced with new layout structure, 3-dot menu, text alignment, and no-email handling
- `ui/src/components/CommitteeNotificationsToggle.tsx` - New component with mobile-optimized tooltip
- `ui/src/components/FlagButton.tsx` - Updated to support text menu item rendering
- `ui/src/lib/session-utils.ts` - Added PWA installation utilities
- `ui/src/lib/api-client.ts` - Updated EventItem type with additional fields

**Key Technical Decisions:**
- **Mobile Tooltip**: Custom implementation instead of Radix tooltip for better mobile control
- **Viewport Awareness**: CSS `min()` function for responsive width constraints
- **Device Detection**: Touch capability detection for behavior switching
- **Event Handling**: Proper cleanup and scroll/outside-click detection
- **3-dot Menu**: Hover/click dual behavior with proper state management
- **No-Email Handling**: Graceful fallback with informative dialog
- **Text Menu Items**: FlagButton conditional rendering for menu vs button contexts

**Styling Approach:**
- Centered layout for titles, tags, and buttons
- Left-aligned text for description, date, and location sections
- Gray background sections for visual separation
- 3-dot menu positioned absolutely in top-right corner
- Dark mode support maintained throughout
- Responsive design with mobile-first considerations
- Accessibility compliance with proper ARIA labels and DialogDescription

This implementation leverages existing infrastructure and focuses on UI/UX enhancements to create a polished event details experience with excellent mobile usability.

---

## ✅ **Implementation Status: COMPLETED**

**Feature successfully implemented and deployed as of December 2024.**

**Key Implementation Details:**
- All components modularized into focused, reusable components
- Performance optimized with 96% reduction in API data transfer
- Mobile-first design with touch-optimized interactions
- PWA integration with installation prompts
- Comprehensive error handling and accessibility compliance

**See 0032_REVIEW.md for detailed implementation notes and performance metrics.**