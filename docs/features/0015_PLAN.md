# Feature 0015: Fix Mobile Map Loading Timeout

## Overview
Mobile users are experiencing frequent map loading timeouts with the error "Map failed to load within 30 seconds. This is common on mobile devices." The current 30-second timeout is too aggressive and doesn't account for various mobile-specific issues like slower networks, device performance, and geolocation delays.

## Technical Requirements

### Current Behavior
- Map has a 30-second timeout on mobile devices, 10 seconds on desktop
- Both timeouts are too aggressive and don't account for network variability
- When timeout occurs, users see a fallback UI asking to "Try Again" or "Use List View"
- Timeout is triggered regardless of actual loading progress
- No retry mechanism or progressive loading
- Geolocation requests may be blocking or slowing down map initialization

### Desired Behavior
- Increase both mobile (30s→60s) and desktop (10s→25s) timeouts to reasonable durations
- Implement progressive loading with better loading state detection
- Add automatic retry mechanism for failed loads
- Optimize map initialization for both mobile and desktop devices
- Provide better user feedback during loading
- Handle network connectivity issues gracefully
- Reduce initial data load to improve performance across all devices

## Root Cause Analysis

### Identified Issues
1. **Overly aggressive timeouts**: Both mobile (30s) and desktop (10s) timeouts are too short for variable network conditions
2. **Blocking geolocation**: Location requests may delay map initialization
3. **Heavy initial load**: Loading all events and map layers at once
4. **Poor loading feedback**: Users don't know if progress is being made
5. **No retry logic**: Failed loads require manual intervention
6. **Network sensitivity**: Both mobile and desktop networks can be unreliable

## Files to Modify

### `ui/src/routes/MapView.tsx`
**Location**: Lines 15-23 (timeout logic)
**Issue**: Fixed 30-second timeout, no retry mechanism

**Current Code**:
```typescript
// Set a timeout for map loading (30 seconds on mobile, 10 on desktop)
const timeout = isMobile ? 30000 : 10000;
const timer = setTimeout(() => {
    if (isMobile) {
        logAction('Map load timeout - showing fallback');
        setMapLoadTimeout(true);
        setError('Map failed to load within 30 seconds. This is common on mobile devices.');
    }
}, timeout);
```

### `ui/src/hooks/useMapboxMap.ts`
**Location**: Lines 59-72 (map loading detection)
**Issue**: Basic loading detection, no progressive feedback

### `ui/src/components/MapboxMap.tsx`
**Location**: Lines 42-67 (handleMapLoad function)
**Issue**: Heavy initial load with all events and layers

### `ui/src/hooks/useUserLocation.ts`
**Location**: Lines 17-26 (request function)
**Issue**: Blocking geolocation request may delay map load

## Proposed Solutions

### Phase 1: Timeout and Retry Improvements

#### 1. Increase Timeouts for Both Mobile and Desktop
```typescript
// Increase timeouts: mobile 30s→60s, desktop 10s→25s
const timeout = isMobile ? 60000 : 25000;
```

#### 2. Add Retry Mechanism
```typescript
const [retryCount, setRetryCount] = useState(0);
const maxRetries = 2;

// In timeout handler
if (retryCount < maxRetries) {
  setRetryCount(prev => prev + 1);
  // Retry loading instead of showing fallback
} else {
  // Show fallback after max retries
}
```

### Phase 2: Loading Optimization

#### 3. Implement Progressive Loading
```typescript
// Load map first, then add layers progressively
const handleMapLoad = useCallback(async (map: mapboxgl.Map) => {
  // Basic map ready - clear loading state
  setIsLoading(false);

  // Load events in background
  loadEventsProgressively(map);
}, [userCoords]);
```

#### 4. Non-blocking Geolocation
```typescript
// Don't block map load on geolocation
useEffect(() => {
  // Request location asynchronously without blocking
  if (locationStatus === 'granted' || locationStatus === 'prompt') {
    requestLocation().catch(() => {
      // Handle geolocation failure gracefully
    });
  }
}, [locationStatus, requestLocation]);
```

### Phase 3: Network and Performance

#### 5. Add Network Connectivity Check
```typescript
const checkNetworkConnectivity = () => {
  return navigator.onLine &&
         navigator.connection?.effectiveType !== 'slow-2g' &&
         navigator.connection?.effectiveType !== '2g';
};
```

#### 6. Reduce Initial Data Load
```typescript
// Load fewer events initially, add more as user interacts
const loadEventsProgressively = async (map: mapboxgl.Map) => {
  // Load events within viewport first
  const initialEvents = await api.browse({
    range: 30, // Shorter range initially
    bounds: map.getBounds()
  });

  // Load additional events in background
  setTimeout(() => loadAdditionalEvents(map), 2000);
};
```

### Phase 4: Better User Experience

#### 7. Enhanced Loading States
```typescript
const [loadingStage, setLoadingStage] = useState<'initializing' | 'loading-map' | 'loading-data' | 'ready'>('initializing');

useEffect(() => {
  if (map) setLoadingStage('loading-data');
  if (events.length > 0) setLoadingStage('ready');
}, [map, events]);
```

#### 8. Smart Timeout Based on Network
```typescript
const getTimeoutDuration = () => {
  const connection = navigator.connection;
  if (!connection) return isMobile ? 60000 : 25000;

  switch (connection.effectiveType) {
    case '4g': return isMobile ? 45000 : 20000;
    case '3g': return isMobile ? 60000 : 25000;
    case '2g':
    case 'slow-2g': return 90000;
    default: return isMobile ? 60000 : 25000;
  }
};
```

## Implementation Steps

### Step 1: Increase Timeout Duration
- Update timeout from 30s to 60s for mobile, 10s to 25s for desktop
- Add network-aware timeout logic
- Update error messages to reflect new timeouts

### Step 2: Implement Retry Logic
- Add retry counter state
- Implement automatic retry on timeout
- Show retry progress to user
- Limit maximum retry attempts

### Step 3: Optimize Loading Process
- Make geolocation non-blocking
- Implement progressive event loading
- Add loading stage indicators
- Reduce initial data payload

### Step 4: Add Network Awareness
- Detect network connectivity
- Adjust timeout based on connection speed
- Provide network-specific error messages
- Handle offline scenarios gracefully

### Step 5: Enhanced Error Recovery
- Better error messages based on failure type
- Automatic recovery mechanisms
- User-friendly retry options
- Fallback to list view with clear messaging

## Testing Requirements

1. **Network Conditions**: Test on various network speeds (4G, 3G, 2G, offline) on both mobile and desktop
2. **Device Types**: Test on different mobile devices, tablets, and desktop browsers
3. **Geolocation States**: Test with granted/denied/prompt permissions on all platforms
4. **Retry Logic**: Verify automatic retry works and respects limits across devices
5. **Progressive Loading**: Ensure map loads quickly, then enhances with data on all platforms
6. **Error Scenarios**: Test various failure modes and recovery on mobile and desktop
7. **Timeout Behavior**: Verify new timeout durations work appropriately for each platform

## Impact Assessment

### Risk Level: **MEDIUM**
- Changes to timeout logic could affect user experience
- Retry logic needs careful implementation to avoid loops
- Network detection may not work on all browsers
- Progressive loading requires careful state management

### Backward Compatibility: **HIGH**
- Existing functionality preserved
- Fallback behavior maintained
- No breaking changes to API contracts

### Performance Impact: **POSITIVE**
- Faster perceived loading with progressive enhancement
- Better mobile performance with optimized loading
- Reduced data usage with selective loading
- Improved user experience on slow networks

## Success Metrics

1. **Reduce timeout errors by 80%** on both mobile and desktop devices
2. **Improve map load success rate** to >95% across all network conditions and devices
3. **Reduce average load time** by implementing progressive loading
4. **Increase user satisfaction** with better loading feedback and recovery options on all platforms

## Dependencies

- **Network Information API**: For connection speed detection
- **Geolocation API**: Enhanced error handling
- **Mapbox GL JS**: Progressive loading capabilities
- **React hooks**: For state management of loading stages

This comprehensive approach addresses the root causes of mobile map loading issues while providing a much better user experience through progressive enhancement and intelligent retry logic.
