# Feature 0025: Fix map reloading behavior - remove forced remounts and implement proper readiness detection

## Brief description
The map loads successfully but keeps reloading due to a flawed retry mechanism that forces component remounts. The issue is in `MapView.tsx` where a `key={`map-retry-${retryCount}`}` causes the entire `MapboxMap` component to unmount/remount on every timeout, even when the map is already working. This creates an endless cycle of reloads. We need to remove this forced remounting and implement proper readiness detection that only retries on actual failures.

## Critical Bug Fix: Infinite Loop Issue
During implementation, a critical infinite re-render loop was discovered and fixed:

### Root Cause of Infinite Loop
1. **Inline callback functions**: `onReady`, `onError`, `onProgress` were defined inline in JSX, causing recreation on every render
2. **useEffect dependency issue**: `isRetrying` was included in dependency array but set inside the same useEffect
3. **Excessive progress events**: 'render' event was firing too frequently, causing constant timeout resets

### Fixes Applied
1. **Memoized callbacks**: Moved all callback functions to useCallback with proper dependencies
2. **Fixed dependency array**: Removed `isRetrying` from useEffect dependency array
3. **Throttled progress events**: Added 1-second throttling and removed 'render' event listener
4. **Stable references**: Ensured all callback functions have stable references across renders

## Root cause analysis
- **Forced remounting**: `MapView.tsx:167` has `key={`map-retry-${retryCount}`}` that destroys and recreates the map component on timeout
- **Premature timeouts**: Timeout triggers even when map is successfully loading but hasn't reached "ready" state yet
- **No readiness detection**: No mechanism to detect when map is actually ready and cancel the timeout
- **Retry on success**: System retries even when map loads successfully, just not fast enough

## Files to change
- `ui/src/routes/MapView.tsx` - Remove forced remount key, add readiness detection
- `ui/src/components/MapboxMap.tsx` - Add readiness callback props
- `ui/src/hooks/useMapboxMap.ts` - Add progress tracking and readiness signaling
- `ui/src/lib/mapbox.ts` - Add error classification utilities

## Technical plan

### Phase 1 — Remove forced remount mechanism
- **Remove** `key={`map-retry-${retryCount}`}` from `MapboxMap` in `MapView.tsx`
- Replace with proper state management for retry coordination
- Ensure map component maintains its state across retry attempts

### Phase 2 — Add proper map readiness detection
- Add `onReady` callback prop to `MapboxMap` component
- Wire `onReady` through `useMapboxMap` hook to fire when map reaches `load` event
- In `MapView.tsx`, cancel timeout and clear loading state when `onReady` fires
- Add progress tracking via `styledata`, `sourcedata`, `render` events to reset timeout

### Phase 3 — Implement intelligent retry logic
- Only retry on actual errors, not timeouts
- Add error classification: recoverable vs non-recoverable
- Implement exponential backoff for recoverable errors
- Add maximum retry limits (3-4 attempts)

### Phase 4 — Improve timeout handling
- Network-aware timeouts remain but only trigger fallback after confirmed failure
- Reset timeout on any map progress events
- Add minimum time-to-ready thresholds to prevent premature fallbacks
- Distinguish between "loading slowly" vs "actually failed"

### Phase 5 — Better error handling and user feedback
- Classify errors by type: token missing, network failure, container issues, etc.
- Show appropriate error messages and retry options
- Add manual retry button for user-initiated retries
- Improve loading indicators to show actual progress vs retry status

## Step-by-step implementation

### `ui/src/routes/MapView.tsx` changes:
```typescript
// Remove this line:
<MapboxMap key={`map-retry-${retryCount}`} ... />

// Add readiness and error callbacks:
<MapboxMap 
  onReady={() => {
    // Cancel timeout, clear loading state
    setMapLoadTimeout(false);
    setIsRetrying(false);
    setLoading(false, 'Map loaded successfully');
  }}
  onError={(error) => {
    // Classify error and decide whether to retry
    if (isRecoverableError(error)) {
      handleRetry();
    } else {
      setMapLoadTimeout(true);
      setError(getErrorMessage(error));
    }
  }}
  onProgress={() => {
    // Reset timeout on progress
    resetTimeout();
  }}
  ...
/>
```

### `ui/src/components/MapboxMap.tsx` changes:
- Add props: `onReady?: () => void`, `onError?: (error: Error) => void`, `onProgress?: () => void`
- Wire these callbacks to the `useMapboxMap` hook
- Remove retryCount logging (no longer needed)

### `ui/src/hooks/useMapboxMap.ts` changes:
- Add progress event listeners: `styledata`, `sourcedata`, `render`, `idle`
- Call `onProgress` on any progress event
- Ensure `onReady` is called exactly once when map reaches `load` event
- Add error classification helpers

### `ui/src/lib/mapbox.ts` changes:
- Add `classifyMapError(error)` function to categorize errors
- Add `isRecoverableError(error)` helper
- Add `getErrorMessage(error)` for user-friendly messages

## Error classification system
- **Non-recoverable**: Missing token, invalid container, configuration errors → Show error, no retry
- **Recoverable**: Network timeouts, style loading failures, temporary errors → Retry with backoff
- **User-actionable**: Offline, permission denied → Show specific guidance

## Validation criteria
- Map loads once and stays loaded (no more endless reloading)
- Network timeouts don't trigger unnecessary retries
- Actual failures still show appropriate error messages
- Progress events prevent premature timeouts on slow connections
- Manual retry works when user initiates it
- Loading indicators accurately reflect map state

## Rollback plan
- Keep original retry mechanism as fallback if new approach fails
- Add feature flag to toggle between old and new retry logic
- Monitor error rates and loading success rates post-deployment

## Testing scenarios
1. **Normal load**: Map loads successfully without retries
2. **Slow network**: Map loads eventually, timeout doesn't trigger during loading
3. **Network failure**: Proper error classification and retry logic
4. **Token missing**: Clear error message, no retry loop
5. **Container issues**: Recovery attempt with proper cleanup
6. **Mobile devices**: Improved performance with progress tracking

## Implementation Status
✅ **Phase 1**: Removed forced remount mechanism
✅ **Phase 2**: Added proper map readiness detection
✅ **Phase 3**: Implemented intelligent retry logic
✅ **Phase 4**: Improved timeout handling
✅ **Phase 5**: Better error handling and user feedback
✅ **Critical Bug Fix**: Resolved infinite loop issue

## Testing Status
The implementation has been deployed and the infinite loop issue has been resolved. The map should now:
- Load once and stay loaded
- Only retry on actual errors
- Reset timeouts appropriately on progress
- Provide clear error messages for different failure types

## Additional Considerations
- Progress events are throttled to 1 second to prevent excessive timeout resets
- Callback functions are properly memoized to prevent re-renders
- Error classification provides user-friendly messages
- Network-aware timeouts remain in place for optimal UX
