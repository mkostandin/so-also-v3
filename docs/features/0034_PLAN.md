# Feature Plan: Committee Tag Filter Dropdown

## Overview

Add a committee tag filter dropdown positioned below the existing event type filter. This feature enhances event filtering by allowing users to filter events by specific committees while maintaining consistent UX across all views (Map, List, Calendar) through local storage persistence. Committee tags are always displayed in ALL CAPS regardless of input format, with a standardized naming convention.

## Technical Requirements

### 1. Database Schema Changes

**Create New Committees Table**
- Add `committees` table to store unique committee names and slugs
- Include fields: `id`, `name`, `slug`, `created_at`, `updated_at`
- Add index on `slug` for efficient lookups
- Add index on `name` for case-insensitive searches
- Store normalized ALL CAPS committee names
- Store URL-friendly slugs derived from normalized names

**Committee Naming Convention**
- Strict format validation with user guidance during submission
- **Allowed formats:**
  - Regional committees: "NECYPAA", "MSCYPAA", "RISCYPAA", "NHSCYPAA"
  - Advisory committees: "NECYPAA ADVISORY", "MSCYPAA ADVISORY"
  - BID committees: "RHODE ISLAND BID FOR NECYPAA", "MASSACHUSETTS BID FOR YPAA"
- **Not allowed:** "NECYPAA EXECUTIVE", "THE NEW HAMPSHIRE CONFERENCE OF YOUNG PEOPLE IN AA"
- Remove leading "THE" from BID committees for deduplication
- All committee names normalized to ALL CAPS regardless of input
- User reminders during submission to follow naming conventions
- Prevent duplicate committees through normalization

**Migration Strategy**
- Create initial migration file for committees table
- Add migration logic to populate committees from existing events data
- Normalize all existing committee names to ALL CAPS during migration
- Generate slugs from normalized names
- Remove all test data and reseed with properly formatted committee names
- Ensure backward compatibility with existing committee fields

### 2. API Endpoints

**New Endpoints**
- `GET /api/v1/committees` - Retrieve all available committees for dropdown options (returns normalized ALL CAPS names)
- `POST /api/v1/committees/sync` - Sync committees collection with new entries from events (normalizes input to ALL CAPS)

**Enhanced Existing Endpoints**
- Update `/api/v1/browse` to support committee filtering alongside existing parameters
- Update `/api/v1/events` to support committee filtering
- Update `/api/v1/occurrences` to support committee filtering
- Add committee name normalization in event creation/update endpoints

**Input Validation & Normalization**
- Strict validation for committee name formats with user guidance
- **Valid patterns:**
  - Regional: /^[A-Z]+YPAA$/ (e.g., "NECYPAA", "MSCYPAA", "RISCYPAA")
  - Advisory: /^[A-Z]+YPAA ADVISORY$/ (e.g., "NECYPAA ADVISORY", "MSCYPAA ADVISORY")
  - BID committees: /^[A-Z\s]+BID FOR Y?PAA$/ (e.g., "RHODE ISLAND BID FOR NECYPAA")
- **Reject patterns:** "NECYPAA EXECUTIVE", "THE NEW HAMPSHIRE CONFERENCE OF YOUNG PEOPLE IN AA"
- Remove leading "THE" from BID committee submissions
- Provide user feedback/reminders for invalid formats during submission
- Normalize all committee inputs to ALL CAPS before storage
- Generate slugs from normalized names for URL-friendly identifiers

### 3. Frontend Components

**CommitteeFilter Component**
- Create `CommitteeFilter.tsx` component with dropdown UI
- Position below existing `EventTypeFilter` component
- Use ShadCN Select component for consistent styling
- Include "ALL COMMITTEES" default option (displayed in ALL CAPS)
- Support multi-select functionality
- Display all committee names in ALL CAPS regardless of stored format
- Sort committees alphabetically by normalized name

**Display Consistency**
- Ensure all committee names displayed in ALL CAPS across entire application
- Update event detail views to show committee names in ALL CAPS
- Update event creation/editing forms to normalize input to ALL CAPS
- Maintain ALL CAPS display in filter dropdown, event cards, and detail views

**Integration Points**
- Integrate into `MapIndex.tsx` FilterContext
- Update `MapView.tsx`, `ListView.tsx`, `CalendarView.tsx` to include committee filter
- Maintain consistent positioning across all views

### 4. State Management

**FilterContext Updates**
- Add `selectedCommittees` state (string array of committee slugs)
- Add `setSelectedCommittees` function
- Add `availableCommittees` state for dropdown options
- Add `committeesLoading` and `committeesError` states

**Local Storage Persistence**
- Store selected committees in localStorage with key `selected-committees`
- Implement persistence logic similar to existing filter patterns
- Restore selections on component mount
- Clear localStorage when "All Committees" is selected

### 5. Data Flow

**Committee Sync Algorithm**
1. Query events for unique committee/committee_slug combinations
2. Remove leading "THE" from BID committee names for deduplication
3. Normalize all committee names to ALL CAPS format
4. Validate names against strict patterns (regional, advisory, BID only)
5. Reject invalid formats like "NECYPAA EXECUTIVE" or long descriptive names
6. Generate slugs from normalized names
7. Compare with existing committees table
8. Insert new committees not already present
9. Update last_seen timestamp for existing committees
10. Return updated committees list with ALL CAPS names

**Data Seeding & Migration**
1. Add test_data flag to events and committees tables for easy cleanup
2. Remove all existing test data from events and committees tables before seeding
3. Create large seed dataset (~100 events) with diverse committee representations
4. Ensure all seed committee names follow ALL CAPS convention and validation rules
5. Include comprehensive set of regional committees: NECYPAA, MSCYPAA, RISCYPAA, NHSCYPAA, etc.
6. Include BID-related committees and advisory committees
7. Distribute events across different regions and committee types for realistic testing
8. Include approximate US-based lat/long coordinates for all test events
9. Update seed scripts to prevent duplicates and maintain ALL CAPS format for future data
10. Mark all seeded data with test_data flag for easy identification and removal

**Address & Geolocation Handling**
- **Address Storage:** Preserve original address components for display (address, city, state_prov, country, postal)
- **Geolocation Approach:** Store lat/long in schema, perform geolocation lookup after submission
  - Use external API (MapBox/Google) for coordinate lookup during event submission
  - Store coordinates in existing latitude/longitude fields
  - Handle API failures gracefully with fallback coordinates
- **Test Data Handling:** Use approximate US-based lat/long coordinates for seed data
  - Don't require perfect accuracy for test events
  - Use coordinates roughly corresponding to address locations
  - Ensure test data has valid coordinates for mapping functionality
- **Display Requirements:** Original address must be available for event details view
- **Mapping Optimization:** Lat/long needed for efficient map rendering and distance calculations
- **Data Integrity:** Ensure address components are properly normalized and stored

**Filter Application**
1. Apply committee filter to API requests using normalized slugs
2. Combine with existing event type filters
3. Display committee names in ALL CAPS in filter results
4. Maintain filter state across view switches
5. Update map markers, list items, and calendar events accordingly

### 6. UI/UX Implementation

**Dropdown Design**
- Use consistent styling with existing filters
- Include committee name in ALL CAPS format
- Include optional count of events per committee
- Support keyboard navigation and screen readers
- Show loading state while fetching committees
- Handle empty state when no committees available
- Sort committees alphabetically by ALL CAPS name

**Display Consistency**
- All committee names displayed in ALL CAPS across application
- Event creation forms normalize input to ALL CAPS
- Event detail views show committees in ALL CAPS
- Filter selections persist with normalized committee names
- Search and filtering work with ALL CAPS committee names

**User Guidance During Submission**
- Real-time validation feedback in committee input fields
- Show allowed format examples: "NECYPAA", "NECYPAA ADVISORY", "RHODE ISLAND BID FOR NECYPAA"
- Display warnings for invalid formats like "NECYPAA EXECUTIVE"
- Suggest corrections for common mistakes (e.g., remove "THE" from BID committees)
- Prevent form submission for invalid committee names

**Responsive Behavior**
- Stack vertically on mobile devices
- Maintain horizontal scroll behavior for event type filter
- Ensure touch-friendly interaction areas

### 7. Performance Optimizations

**Query Optimization**
- Cache committees list in memory for session duration
- Implement efficient sync queries using database indexes
- Limit committee options to those with active/future events
- Use pagination for large committee lists if needed

**Frontend Performance**
- Debounce filter updates to prevent excessive API calls
- Implement virtual scrolling for large committee lists
- Optimize re-renders with proper memoization
- Pre-load committee options on initial page load

### 8. Error Handling

**API Error Scenarios**
- Handle network failures when fetching committees
- Graceful fallback when committee sync fails
- Display user-friendly error messages
- Retry mechanisms for transient failures

**Data Consistency**
- Handle cases where committee data is missing or malformed
- Validate committee slugs before filtering
- Ensure filter state remains valid across data updates

## Implementation Phases

### Phase 1: Database & API Foundation
- Add test_data boolean flag to events and committees tables
- Create committees table schema with ALL CAPS normalization
- Implement database migration with data cleanup
- Add strict committee name validation (regional, advisory, BID patterns only)
- Implement deduplication logic (remove "THE" from BID committees)
- Add committee sync endpoint with validation and normalization logic
- Update existing API endpoints for committee filtering
- Implement geolocation API integration (MapBox/Google) for coordinate lookup
- Add graceful fallback for API failures during submission
- Remove all test data and reseed with large dataset (~100 events) including approximate coordinates

### Phase 2A: Frontend Components
- Create CommitteeFilter component with ALL CAPS display
- Implement strict input validation with user guidance in forms
- Add real-time validation feedback for committee submissions
- Integrate with FilterContext using normalized committee names
- Add local storage persistence for normalized selections
- Update all view components (Map, List, Calendar) to display ALL CAPS

### Phase 2B: UI Integration & User Guidance
- Position committee filter below event type filter
- Implement responsive design with ALL CAPS consistency
- Add loading and error states
- Implement user guidance system for committee submissions
- Show format examples and validation warnings
- Prevent submission of invalid committee names
- Test cross-view consistency with normalized display

## Testing Requirements

### Unit Tests
- CommitteeFilter component rendering with ALL CAPS display
- Committee name normalization functions (including "THE" removal from BID committees)
- Strict committee name validation (regional, advisory, BID patterns)
- Filter state management with normalized committee names
- Local storage persistence for normalized selections
- API integration with committee validation
- Slug generation from normalized names
- User guidance message generation for invalid submissions
- Geolocation API integration functions
- Coordinate fallback logic for API failures
- Address component normalization

### Integration Tests
- End-to-end committee filtering workflow with ALL CAPS display
- Cross-view filter persistence maintaining ALL CAPS format
- Database sync functionality with normalization and deduplication
- Strict committee name validation (regional, advisory, BID patterns only)
- Error handling scenarios for invalid committee formats
- BID committee validation and deduplication ("THE RHODE ISLAND BID FOR NECYPAA" â†’ "RHODE ISLAND BID FOR NECYPAA")
- Rejection of invalid formats like "NECYPAA EXECUTIVE" or "THE NEW HAMPSHIRE CONFERENCE OF YOUNG PEOPLE IN AA"
- User guidance feedback during committee submission
- Data seeding verification with large dataset (~100 events) including coordinate data
- Test data cleanup and reseeding without duplicates
- Address storage and display verification
- Geolocation API integration testing (success and failure scenarios)
- Coordinate accuracy validation for test data

### Performance Tests
- Large committee list rendering with ALL CAPS names
- Filter application performance with normalized data
- Memory usage with persistent state
- Database query performance with committee normalization
