# Mapbox Marker Popup Redesign ✅ FULLY IMPLEMENTED

## Feature Overview
Redesign the mapbox marker popups to have better visual hierarchy and structure. The title text should be larger than description text, restructure the content layout, improve date/time formatting to "Sep 7 at 6:00pm" format, and simplify dismissal UX (no close button; tap outside/drag to close).

## Current Structure Analysis
The popup is rendered via `EventPreviewPopup` component with the following current layout:
- Event image (if available)
- Event title (text-base, smaller)
- Event type badge
- Event description (text-sm, larger)
- Date and time (separate lines)
- Distance
- Learn More button

## Required Changes

### 1. Text Size Swap
- Change title from `text-base` to `text-lg` or `text-xl` for larger, more prominent display
- Change description from `text-sm` to `text-xs` or keep as `text-sm` but ensure title is larger
- Update line 71 in `EventPreviewPopup.tsx` to increase title font size
- Update line 86 in `EventPreviewPopup.tsx` to decrease description font size

### 2. Content Structure Reorganization
Restructure the popup layout to follow this specific order:
1. **Title** - Make this the most prominent element
2. **Event tag** - Display event type badge
3. **Date and Time** - Format as "Sep 7 at 6:00pm" instead of separate date/time lines
4. **Description** - Position after date/time
5. **Learn More button** - Keep at bottom
6. **Dismissal** - No close button; tap outside or drag to dismiss

### 3. Date/Time Format Update
- Replace current separate date/time display (lines 92-106) with combined format
- Create new date formatting function to output "Sep 7 at 6:00pm" format
- Use abbreviated month names and 12-hour time format with "at" conjunction

### 4. Text Truncation
- Add truncation for title text to prevent excessive length (max 2-3 lines)
- Add truncation for description text to prevent popup overflow (max 3-4 lines)
- Use CSS `line-clamp` utilities or text truncation classes
- Ensure truncated text ends with ellipsis for clear indication
- Maintain responsive truncation that works across different screen sizes

### 5. Dismissal UX (No Close Button)
- Remove header X and footer Close buttons
- Enable tap-outside-to-close using Mapbox `closeOnClick: true`
- Close on map drag (dismiss on `dragstart`) for quick escape
- Keep Learn More as the only footer action
- Rationale: avoid double-tap/conflicts; larger tap-surface (map) for dismissal

### 6. Date/Time Data Integration
- Add `startsAtUtc` field to map feature properties in `MapboxMap.tsx`
- Update `MapLayers.tsx` to include date/time data when creating EventItem objects
- Ensure date/time displays in "Sep 7 at 6:00pm" format for events with date data
- Handle cases where events don't have date/time information gracefully

### 7. Mapbox Controls Cleanup
- Remove all default mapbox controls except user location control
- Disable zoom controls, compass, fullscreen, and scale controls
- Keep only the geolocate/user location control for user positioning
- Ensure clean map interface focused on event markers and user location

### 8. Popup Positioning & Map Centering
- Create popup at marker location
- Immediately center map on marker coordinates when popup opens
- Use smooth easeTo animation (300ms) for map centering
- Ensure popup is always visible in center of map view
- Predictable and reliable positioning for all markers

## Files to Modify

### ui/src/components/EventPreviewPopup.tsx
- Update title styling from `text-base` to `text-lg` (line 71)
- Add title truncation with `line-clamp-2` or `line-clamp-3` to prevent excessive length
- Add proper z-index (z-10) to title to ensure it's below close button
- Update description styling from `text-sm` to `text-xs` (line 86)
- Add description truncation with `line-clamp-3` or `line-clamp-4` to prevent popup overflow
- Restructure component layout to match new order: Title → Event Tag → Date/Time → Description → Learn More
- Replace `formatDateTime` function to return combined "Sep 7 at 6:00pm" format instead of separate date/time objects
- Update date/time rendering section (lines 92-106) to use new format
- Remove header X and footer Close; rely on map interactions for dismissal
- Keep only Learn More as the footer action (full width)

### ui/src/components/EventPopupManager.tsx
- Modify popup creation options (line 30-35) to customize close button appearance
- Add CSS classes or styling to increase close button size and add padding
- Ensure popup positioning accommodates larger close button

### ui/src/components/MapLayers.tsx
- Update event click handlers to use EventPreviewPopup component
- Pass event data correctly to popup component including `startsAtUtc`
- Ensure proper cleanup of React components
- Update both event label and unclustered point click handlers

### ui/src/components/MapboxMap.tsx
- Remove default mapbox controls (zoom, compass, fullscreen, scale)
- Keep only geolocate/user location control
- Configure map initialization to exclude unwanted controls
- Ensure clean map interface with minimal controls
- Add `startsAtUtc` to map feature properties for date/time display
- Center map on marker when popup opens using map.easeTo() (300ms)
- Use `closeOnClick: true` so tapping outside closes the popup
- Close popup on `dragstart` to dismiss when user pans the map

### ui/src/index.css
- Remove close-button specific styling (no header/footer close controls)

## Implementation Notes
- Maintain responsive design for mobile devices
- Preserve dark mode compatibility
- Keep existing loading and error states
- Ensure accessibility with proper contrast and touch targets
- Test popup positioning with larger close button to prevent overlap issues
