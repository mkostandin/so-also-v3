# Feature Plan: Add Mapbox GL to Map View

## Overview
Replace the placeholder map view component with a functional Mapbox GL map that displays event locations with markers and supports user location integration.

## Current State
- `ui/src/routes/MapView.tsx` contains only a placeholder div with styling
- No map library dependencies installed
- Location data (latitude/longitude) exists in events table
- User location hook `useUserLocation` available for geolocation
- API endpoint `/api/v1/browse` provides events with location data

## Implementation Steps

### Phase 1: Dependencies and Environment Setup
**Files to modify:**
- `ui/package.json`: Add Mapbox GL JS dependency
- `.env`: Add `VITE_MAPBOX_ACCESS_TOKEN` environment variable

**Actions:**
1. Install `@mapbox/mapbox-gl` and `@types/mapbox-gl` via pnpm
2. Add Mapbox access token to environment configuration
3. Create environment variable documentation for user setup

### Phase 2: Map Component Implementation
**Files to create:**
- `ui/src/components/MapboxMap.tsx`: Main map component
- `ui/src/hooks/useMapboxMap.ts`: Custom hook for map lifecycle management
- `ui/src/lib/mapbox.ts`: Mapbox configuration and utilities

**Files to modify:**
- `ui/src/routes/MapView.tsx`: Replace placeholder with MapboxMap component

**Key Functions:**
1. **Map Initialization**: Load Mapbox GL JS, create map instance with proper styling and controls
2. **Event Data Fetching**: Use existing `/api/v1/browse` API to fetch events with location data
3. **Marker Rendering**: Convert event locations to map markers with custom styling
4. **User Location Integration**: Display user location marker using `useUserLocation` hook
5. **Map Controls**: Add zoom, geolocation, and navigation controls
6. **Responsive Design**: Ensure map works on mobile and desktop with proper sizing

### Phase 3: Event Data Integration
**Files to modify:**
- `ui/src/lib/api.ts`: Add typed API client functions for event browsing
- `ui/src/components/MapboxMap.tsx`: Integrate event data fetching and marker updates

**Key Functions:**
1. **Data Fetching**: Implement real-time event data fetching with location filtering
2. **Marker Clustering**: Group nearby events using Mapbox GL clustering
3. **Event Details**: Display event information on marker click
4. **Distance Filtering**: Use haversine calculation for radius-based filtering

### Phase 4: User Experience Enhancements
**Files to create:**
- `ui/src/components/EventTypeFilter.tsx`: Dropdown component for event type filtering

**Files to modify:**
- `ui/src/components/MapboxMap.tsx`: Add loading states, error handling, and attribution hiding
- `ui/src/routes/MapView.tsx`: Add map-specific UI elements including filter
- `ui/src/lib/mapbox.ts`: Add CSS for hiding Mapbox attribution

**Key Functions:**
1. **Loading States**: Show loading indicator while map initializes and data loads
2. **Error Handling**: Graceful fallback when Mapbox fails to load or API errors occur
3. **Permission Handling**: Handle geolocation permission states from user location hook
4. **Accessibility**: Add proper ARIA labels and keyboard navigation support
5. **Attribution Hiding**: Apply CSS to hide Mapbox logo and attribution
6. **Event Type Filtering**: Filter markers based on selected event types

## Algorithms Used

### 1. Haversine Distance Calculation (already implemented)
**Location:** `server/src/lib/location.ts`
**Purpose:** Calculate distance between user location and event locations for filtering
**Steps:**
1. Convert latitude/longitude to radians
2. Calculate differences in coordinates
3. Apply haversine formula: `a = sin²(Δlat/2) + cos(lat1) × cos(lat2) × sin²(Δlon/2)`
4. Calculate angular distance: `c = 2 × atan2(√a, √(1-a))`
5. Return distance in meters: `R × c` (where R = Earth's radius)

### 2. Map Clustering Algorithm
**Purpose:** Group nearby event markers to reduce visual clutter
**Steps:**
1. Create marker cluster groups based on zoom level
2. Calculate cluster centers using average coordinates
3. Display cluster count when zoomed out
4. Expand clusters when zoomed in

## Environment Configuration
Add to `.env` file:
```
VITE_MAPBOX_ACCESS_TOKEN=your_mapbox_access_token_here
```

## CSS for Attribution Hiding
Add to Mapbox configuration CSS:
```css
.mapboxgl-ctrl-attrib {
  display: none !important;
}

.mapboxgl-ctrl-logo {
  display: none !important;
}

.mapboxgl-ctrl-attrib.mapboxgl-compact {
  display: none !important;
}
```

## API Integration
**Existing Endpoints:**
- `GET /api/v1/browse?lat={lat}&lng={lng}&radius={meters}`: Fetch events with location filtering
- `GET /api/v1/events`: Fetch all events (fallback if no location)
- `GET /api/v1/browse?committee={slug}`: Filter events by committee (already supported)

**Event Type Filtering:**
Client-side filtering will be implemented to filter the fetched events by event type:
- Filter events array based on selected event types from dropdown
- Update map markers dynamically when filter changes
- Maintain user's current map view and zoom level during filtering

**Response Format:**
```typescript
{
  id: string,
  name: string,
  latitude: number,
  longitude: number,
  startsAtUtc: string,
  // ... other event fields
}
```

## Map Features
1. **Base Map**: Use Mapbox Streets style with dark/light theme support
2. **Event Markers**: Custom markers with event type icons
3. **User Location**: Blue dot marker with accuracy circle
4. **Clustering**: Automatic marker clustering at lower zoom levels
5. **Controls**: Zoom, compass, geolocation button
6. **Event Type Filtering**: Filter dropdown/selector at top of map for event types (Event, Committee Meeting, Conference, YPAA Meeting, Other)
7. **Attribution Removal**: Hide Mapbox logo and attribution using CSS
8. **Responsive**: Full height map with mobile-optimized controls

## Error Scenarios
1. **No Mapbox Token**: Show error message with setup instructions
2. **Geolocation Denied**: Hide user location features gracefully
3. **API Errors**: Show cached data or offline message
4. **Network Issues**: Implement retry logic for data fetching
