# Feature 0023: Stabilize Mapbox MapView load and retry flow

## Brief description
We increased load time and added retries for Mapbox in MapView, but users still hit repeated retries and eventually the fallback “Failed to load map” page. We need reliable initialization, retries that truly reinitialize, progress-aware timeouts, and clearer error handling.

## Current implementation and pain points
- `ui/src/routes/MapView.tsx`
  - Network-aware timeout via `getTimeoutDuration`. Shows fallback after max retries.
  - Tracks `retryCount` and forces remount using `key={`map-retry-${retryCount}`}`.
  - Lacks positive readiness signal; timeout may fire even if the map becomes ready.
- `ui/src/components/MapboxMap.tsx`
  - Accepts `retryCount` but only logs it; does not coordinate readiness with parent.
  - Owns its own loading/error UI separate from MapView’s watchdog.
- `ui/src/hooks/useMapboxMap.ts`
  - Initializes Mapbox; listens to `load` and `error`.
  - No progress pings (style/source/tile activity) to reset parent watchdog.

## Goals
- Cancel MapView’s timeout immediately when the map reports ready.
- Make retries deterministic with proper teardown and re-initialization.
- Use progress signals to avoid false timeouts on slow networks/devices.
- Classify unrecoverable vs. recoverable errors and handle accordingly.

## Files to change
- `ui/src/routes/MapView.tsx`
- `ui/src/components/MapboxMap.tsx`
- `ui/src/hooks/useMapboxMap.ts`
- `ui/src/lib/mapbox.ts` (optional utility additions)
- `ui/src/hooks/useMobileDebug.ts` (optional logging)

## Technical plan

### Phase 1 — Readiness and error wiring
- Add `onReady`, `onError`, and `onProgress` props to `MapboxMap`. Wire them to `useMapboxMap` events.
- In `MapView.tsx`, cancel the watchdog timeout on `onReady`, clear `isRetrying`, and keep the map visible.
- On `onError`, classify error:
  - Token/config/container errors: do not retry; show targeted message.
  - Network/timeouts/unknown transient: allow retry.

### Phase 2 — Deterministic retries
- Replace passive `retryCount` logging with an explicit `restartKey` prop passed to `MapboxMap`.
- In `MapView.tsx`, compute exponential backoff with jitter (e.g., attempt 1: 0–1s, 2: 2–3s, 3: 5–7s), cap attempts (e.g., 3–4).
- When retrying, increment `restartKey` to force a clean re-init. Also listen for `online` to trigger immediate retry when returning from offline.

### Phase 3 — Progress-based watchdog
- In `useMapboxMap.ts`, listen to lightweight progress signals (`styledata`, `dataloading`, `sourcedata`, `render`, `idle`). Maintain `lastProgressAt` and invoke `onProgress`.
- In `MapView.tsx`, reset the watchdog timer on any `onProgress` callback so legitimate slow loads don’t trigger fallback.
- Consider “ready” as `load` + first `render` for faster UX (layers/data can continue to stream).

### Phase 4 — Init performance and sequencing
- Defer non-critical controls (e.g., geolocate) until after `load` or `idle` to reduce first paint work.
- Keep progressive event loading (already present) but ensure it starts after the map is ready; keep background fetch for additional data.
- Optional: evaluate simpler initial style if necessary; only swap after stable `idle` if benefits observed.

### Phase 5 — UX and observability
- Improve loading overlay to show attempt number and a brief message when a retry is scheduled.
- In fallback UI, surface specific cause (offline vs. token missing vs. container error) when known.
- Add structured debug logs via `useMobileDebug` for TTFMP (time-to-first-map-paint), attempts, last progress time, and error categories.

## Step-by-step edits
- `ui/src/components/MapboxMap.tsx`
  - Props: add `onReady?: () => void`, `onError?: (err: Error) => void`, `onProgress?: (ts: number) => void`, `restartKey?: number`.
  - Call `onReady` on initial map readiness; forward `onError` from hook; forward progress pings.
- `ui/src/hooks/useMapboxMap.ts`
  - Subscribe to progress events; update `lastProgressAt`; call `onProgress(lastProgressAt)`.
  - On `load`, set ready and call `onMapLoad`; on `error`, classify and call `onMapError`.
  - Accept `restartKey`; on change, fully dispose existing map and re-init after a brief delay.
- `ui/src/routes/MapView.tsx`
  - Replace `retryCount` display-only flow with `restartKey` and explicit backoff schedule.
  - Start watchdog using `getTimeoutDuration`; reset on `onProgress`; cancel on `onReady`.
  - If offline, pause backoff and wait for `online` event to retry immediately.

## Edge cases
- Missing `VITE_MAPBOX_ACCESS_TOKEN`: show targeted instruction and avoid retry loops.
- Container invalid/dirty: recover by cleanup + short retry.
- Extremely slow network: progress pings prevent false fallbacks.
- App resume on mobile: consider soft re-init on `visibilitychange` if map is stuck.

## Validation
- Normal desktop: no fallback, quick `onReady`.
- Throttled networks (Fast/Slow 3G): retries reinitialize properly; reduced fallback frequency.
- Mobile hardware tests: fewer false fallbacks, successful recovery on retry.
- Offline: immediate targeted message; automatic retry on reconnect.

## Environment
- Ensure `.env` contains `VITE_MAPBOX_ACCESS_TOKEN` for the UI. If missing, display guidance.
