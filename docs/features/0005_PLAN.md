# Database Schema Synchronization Fix

## Overview
The application is experiencing HTTP 500 errors when accessing the `/api/v1/browse` endpoint due to a missing `image_urls` column in the PostgreSQL database. The database schema is defined in the application code but has not been synchronized with the actual database instance.

## Problem Analysis
The error occurs because:
- The `events` table schema in `server/src/schema/events.ts` includes an `image_urls` column of type `jsonb`
- The database query in `server/src/api.ts` (lines 325, 291) attempts to select this column
- However, the database migration files only contain a basic `users` table
- The Drizzle ORM schema push command has not been executed to synchronize the schema

## Technical Details
**Error Location**: `server/src/api.ts:309-359` (browse endpoint)
**Missing Column**: `image_urls` in `app.events` table
**Database Error**: `column "image_urls" does not exist at character 223`

## Solution Phases

### Phase 1: Database Schema Synchronization
**Objective**: Push the current Drizzle schema to the database to create missing tables and columns.

**Files Involved**:
- `server/src/schema/events.ts` - Contains the events table definition with image_urls column
- `server/src/schema/*.ts` - All schema files defining the database structure
- `server/drizzle.config.ts` - Drizzle configuration for schema management

**Commands Required**:
```powershell
cd server
pnpm db:push
```

**Expected Outcome**:
- Creates the `app.events` table with all required columns including `image_urls`
- Creates all other missing tables (conferences, occurrences, series, etc.)
- Database schema matches the TypeScript definitions

### Phase 2: Verification and Testing
**Objective**: Confirm the database schema is properly applied and the API endpoints work correctly.

**Files Involved**:
- `server/src/api.ts` - Contains the browse endpoint that was failing
- `ui/src/components/MapboxMap.tsx` - Frontend component calling the failing API
- `ui/src/components/ListView.tsx` - Another component calling the failing API

**Verification Steps**:
1. Test database connectivity
2. Verify table creation with correct schema
3. Test the `/api/v1/browse` endpoint returns 200 instead of 500
4. Confirm frontend components load without errors

## Implementation Steps

### Step 1: Execute Schema Push
Run the Drizzle push command to synchronize the database schema:
```powershell
cd server
npx dotenv-cli -e .env -- pnpm db:push
```

### Step 2: Verify Schema Creation
Check that the events table now contains the image_urls column:
```sql
SELECT column_name, data_type FROM information_schema.columns
WHERE table_schema = 'app' AND table_name = 'events'
AND column_name = 'image_urls';
```

### Step 3: Test API Endpoint
Make a request to the browse endpoint to ensure it returns successfully:
```powershell
curl "http://localhost:5500/api/v1/browse?range=90"
```

### Step 4: Verify Frontend Integration
Ensure the MapboxMap and ListView components can successfully fetch and display event data.

## Risk Mitigation
- **Backup Strategy**: The current database only contains users table, minimal data loss risk
- **Rollback Plan**: If schema push fails, the existing database state can be restored
- **Testing**: All API endpoints using the events table should be tested post-deployment

## Dependencies
- PostgreSQL database must be running and accessible
- Environment variables must be properly configured
- Drizzle Kit must be installed and configured correctly

## Success Criteria
- HTTP 500 errors eliminated from `/api/v1/browse` endpoint
- Database contains all required tables with correct schema
- Frontend components load event data without errors
- No data loss during schema synchronization
