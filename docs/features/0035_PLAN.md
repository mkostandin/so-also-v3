# Fix Committee Filtering in Map and Calendar Views

## Overview

Committee filtering is currently only working in the List View. The Map View and Calendar View are not applying committee filters because they fetch events independently from the shared FilterContext events.

## Current State Analysis

### Working Implementation (List View)
- Uses shared `events` state from `FilterContext` in `MapIndex.tsx`
- Committee filtering is applied during the `api.browse()` call in `MapIndex.tsx` (lines 179-181)
- Filtering happens at the API level before events are shared across views

### Broken Implementation (Map View)
- Uses `MapboxMap` component which has its own event fetching logic
- `MapboxMap` component doesn't receive committee filtering parameters
- No committee filtering is applied to map markers

### Broken Implementation (Calendar View)
- Uses `useCalendarEvents` hook which fetches events independently
- `useCalendarEvents` calls `api.browse()` without committee parameters (lines 56-60)
- Committee filtering is completely missing from calendar events

## Root Cause

The issue stems from inconsistent event fetching patterns:

1. **ListView**: Uses shared events from FilterContext ✅
2. **MapView**: Uses MapboxMap component with independent fetching ❌
3. **CalendarView**: Uses useCalendarEvents hook with independent fetching ❌

## Technical Solution

### Phase 1: Update Calendar View
**Files to modify:**
- `ui/src/hooks/useCalendarEvents.ts` - Add committee filtering parameter
- `ui/src/routes/CalendarView.tsx` - Pass selectedCommittees to useCalendarEvents

**Changes:**
1. Modify `useCalendarEvents` hook to accept `selectedCommittees` parameter
2. Update the `api.browse()` call to include committee filtering
3. Pass `selectedCommittees` from CalendarView to the hook

### Phase 2: Update Map View
**Files to modify:**
- `ui/src/components/MapboxMap.tsx` - Add committee filtering support
- `ui/src/routes/MapView.tsx` - Pass selectedCommittees to MapboxMap

**Changes:**
1. Modify `MapboxMap` component to accept `selectedCommittees` prop
2. Update internal event fetching to include committee parameters
3. Pass `selectedCommittees` from MapView to MapboxMap component

### Phase 3: API Integration Verification
**Files to verify:**
- `ui/src/lib/api-client.ts` - Ensure committee filtering works correctly
- Server API endpoints - Verify committee parameter handling

**Changes:**
1. Test that all API endpoints properly handle committee filtering
2. Ensure consistent parameter naming across all endpoints

## Implementation Details

### Calendar View Fix
```typescript
// In useCalendarEvents.ts
export function useCalendarEvents(
  distance: string = "150", 
  selectedEventTypes: string[] = [],
  selectedCommittees: string[] = [] // Add this parameter
): CalendarEventsData {
  // ... existing code ...
  
  const fetchEvents = useCallback(async () => {
    // ... existing code ...
    
    const rawEvents = await api.browse({
      lat,
      lng,
      radius,
      committees: selectedCommittees, // Add committee filtering
    });
    
    // ... rest of existing code ...
  }, [userCoords, distance, selectedCommittees]); // Add selectedCommittees to dependencies
}
```

### Map View Fix
```typescript
// In MapboxMap.tsx
interface MapboxMapProps {
  // ... existing props ...
  selectedCommittees?: string[]; // Add this prop
}

// In MapboxMap component
const MapboxMap = ({ selectedCommittees = [], /* ... other props */ }) => {
  // Update event fetching to include committees
  const events = await api.browse({
    lat,
    lng,
    radius,
    committees: selectedCommittees,
  });
};
```

## Testing Strategy

### Phase 1 Testing
1. Select committees in Calendar View
2. Verify events are filtered correctly
3. Switch between different committee selections
4. Verify event counts match filtered results

### Phase 2 Testing
1. Select committees in Map View
2. Verify map markers show only filtered events
3. Switch between different committee selections
4. Verify marker counts match filtered results

### Cross-View Consistency Testing
1. Select committees in one view
2. Switch to another view
3. Verify same filtering is applied
4. Test committee selection persistence across view switches

## Implementation Details

### Phase 1: Calendar View Implementation (COMPLETED)
**Files Modified:**
- `ui/src/hooks/useCalendarEvents.ts`
- `ui/src/routes/CalendarView.tsx`

**Changes:**
1. **useCalendarEvents Hook**: Added `selectedCommittees` parameter to the hook signature
2. **API Integration**: Updated `api.browse()` calls to include committee filtering when `selectedCommittees.length > 0`
3. **Dependency Management**: Added `selectedCommittees` to the `useCallback` dependency array to trigger re-fetching when committee selection changes
4. **CalendarView Integration**: Updated CalendarView to pass `selectedCommittees` from FilterContext to the `useCalendarEvents` hook

### Phase 2: Map View Implementation (COMPLETED)
**Files Modified:**
- `ui/src/components/MapboxMap.tsx`
- `ui/src/routes/MapView.tsx`

**Changes:**
1. **MapboxMap Props**: Added `selectedCommittees?: string[]` prop to the MapboxMapProps interface
2. **Component Signature**: Updated MapboxMap component to accept and destructure the `selectedCommittees` prop
3. **API Integration**: Updated both initial and additional event fetching calls to include committee filtering
4. **Dependency Management**: Updated `loadEvents` useCallback dependency array to include `selectedCommittees`
5. **MapView Integration**: Updated MapView to pass `selectedCommittees` from FilterContext to the MapboxMap component

### Phase 3: Additional Bug Fixes (COMPLETED)
**Files Modified:**
- `ui/src/components/MapLayers.tsx`

**Changes:**
1. **Source Protection**: Added check to prevent adding the 'events' source if it already exists
2. **Layer Protection**: Added checks for all layers before adding them to prevent crashes
3. **Event Handler Protection**: Added checks before adding click handlers
4. **Enhanced Error Handling**: Wrapped all event handlers and paint property changes in try-catch blocks
5. **Defensive Cleanup**: Improved the cleanup function to safely remove layers

## Technical Implementation Details

### Calendar View Filtering Logic
```typescript
// In useCalendarEvents.ts
const rawEvents = await api.browse({
  lat,
  lng,
  radius,
  committees: selectedCommittees.length > 0 ? selectedCommittees : undefined,
});
```

### Map View Filtering Logic
```typescript
// In MapboxMap.tsx
const initialEventData = await api.browse({
  range: 30,
  committees: selectedCommittees.length > 0 ? selectedCommittees : undefined
});

const additionalEventData = await api.browse({
  range: 90,
  committees: selectedCommittees.length > 0 ? selectedCommittees : undefined
});
```

## Consistency with Existing Implementation

The implementation maintains consistency with the existing List View approach:

- **API Parameter**: Uses the same `committees` parameter as defined in `api-client.ts`
- **Conditional Logic**: Only includes committees parameter when `selectedCommittees.length > 0`
- **FilterContext Integration**: Uses the same FilterContext for state management across all views
- **Fallback Behavior**: When no committees are selected, the parameter is `undefined`, allowing the API to return all events

## Testing Strategy

### Code Quality
- **TypeScript**: All changes maintain proper TypeScript typing
- **Linting**: No linter errors introduced
- **Dependencies**: Proper useCallback dependency arrays to prevent infinite re-renders

### Integration Points
- **FilterContext**: All views now use the same committee filtering state
- **API Client**: Leverages existing `api.browse()` method with committee support
- **Event Filtering**: Consistent filtering logic across Map, List, and Calendar views

## Success Criteria

✅ **Committee filtering works in Calendar View**
- Calendar events now respect committee selection
- Events re-fetch when committee selection changes
- Consistent with List View filtering behavior

✅ **Committee filtering works in Map View**
- Map markers now respect committee selection
- Markers update when committee selection changes
- Maintains map performance with proper caching

✅ **Committee filtering works consistently across all views**
- All three views (Map, List, Calendar) use the same FilterContext
- Committee selections persist when switching between views
- API calls include committee filtering appropriately

✅ **No performance regressions**
- Map View uses progressive loading (30 days initially, 90 days additional)
- Calendar View uses efficient event grouping by date
- Proper useCallback dependencies prevent unnecessary re-renders

✅ **API error handling remains robust**
- Maintains existing error handling patterns
- Graceful fallbacks when API calls fail
- Proper loading states during data fetching

✅ **Bug fixes resolved**
- Map View no longer crashes when switching committee selections
- Proper error handling prevents layer/source conflicts
- Enhanced debugging with console warnings

## Risk Assessment

**Low Risk**: This is primarily adding missing functionality rather than changing existing behavior. The List View already works correctly and serves as a reference implementation.

**Issues Addressed:**
- ✅ Performance impact assessed - minimal impact with proper caching
- ✅ MapboxMap component compatibility - additional prop handled correctly
- ✅ Layer management conflicts - resolved with defensive checks

## Rollback Plan

If issues arise, changes can be easily reverted:

1. **Calendar View**: Revert `useCalendarEvents.ts` and `CalendarView.tsx` to previous versions
2. **Map View**: Remove `selectedCommittees` prop from `MapboxMap.tsx` and `MapView.tsx`
3. **Map Layers**: Revert `MapLayers.tsx` to previous version
4. **All changes are isolated and don't affect core application functionality**

## Future Considerations

### Potential Enhancements
- **Caching**: Could implement more sophisticated caching for committee-filtered results
- **Prefetching**: Could prefetch events for recently used committee combinations
- **Analytics**: Could track committee usage patterns across different views

### Monitoring Points
- **API Performance**: Monitor query performance with committee filtering
- **Bundle Size**: Ensure additional filtering logic doesn't significantly impact bundle size
- **User Experience**: Track if committee filtering improves or complicates user workflows

